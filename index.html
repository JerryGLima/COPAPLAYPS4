<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gerenciador de Campeonato de Futebol</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6; /* bg-gray-100 */
        }
        .matchup { position: relative; }
        .round .matchup:not(:last-child ) { margin-bottom: 3rem; }
        .winner { font-weight: 700; color: #b91c1c; }
    </style>
</head>
<body class="text-gray-800">

    <div id="loading-overlay" class="fixed inset-0 bg-white bg-opacity-75 flex items-center justify-center z-50">
        <p class="text-xl font-semibold text-gray-700">Carregando...</p>
    </div>

    <div class="container mx-auto p-4 md:p-8">
        
        <!-- Tela de Login -->
        <div id="login-stage">
             <div class="max-w-md mx-auto bg-white p-8 rounded-xl shadow-lg border border-gray-200 mt-16">
                <img src="imagem/logo.png" alt="Logo do Torneio" class="mx-auto mb-6 h-24 w-24 rounded-full object-cover">
                <h2 class="text-3xl font-bold text-center text-gray-900 mb-2">Acesse seu Torneio</h2>
                <p class="text-center text-gray-600 mb-6">Insira seu e-mail para receber um link de acesso mágico. Sem senhas!</p>
                <div id="login-notification-area" class="mb-4"></div>
                <div class="space-y-4">
                    <div>
                        <label for="email-input" class="block mb-2 text-sm font-medium text-gray-700">E-mail</label>
                        <input type="email" id="email-input" class="bg-gray-100 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-red-500 focus:border-red-500 block w-full p-2.5" placeholder="seu@email.com" required>
                    </div>
                    <button id="send-magic-link-btn" class="w-full bg-red-600 hover:bg-red-700 text-white font-bold py-3 px-6 rounded-lg shadow-lg transition-transform transform hover:scale-105">
                        Enviar Link Mágico
                    </button>
                </div>
            </div>
        </div>

        <!-- Conteúdo Principal do App (inicialmente oculto) -->
        <div id="app-container" style="display: none;">
            <header class="text-center mb-10 relative">
                 <div id="auth-status" class="absolute top-0 right-0 text-right text-sm"></div>
                <img id="main-logo-img" src="imagem/logo.png" alt="Logo do Torneio" class="mx-auto mb-4 h-24 w-24 rounded-full object-cover">
                <h1 class="text-4xl md:text-5xl font-bold text-gray-900 tracking-tight">Campeonato de Futebol Digital</h1>
                <p id="tournament-mode-indicator" class="text-gray-600 mt-2 text-lg">Acompanhe a fase de grupos e as eliminatórias!</p>
            </header>

            <main>
                <section id="setup-stage" class="mb-12 bg-white p-6 rounded-xl shadow-lg border border-gray-200">
                    <h2 class="text-3xl font-bold text-gray-900 border-b-2 border-red-500 pb-2 mb-6">Configurar Torneio</h2>
                    
                    <div class="bg-blue-50 border-l-4 border-blue-400 p-4 text-blue-800 rounded-r-lg mb-6">
                        <p class="font-bold">Como funciona a eliminatória?</p>
                        <p class="text-sm">O sistema gera o mata-mata automaticamente baseado no número de grupos:</p>
                        <ul class="list-disc list-inside mt-1 text-sm">
                            <li><strong>Crie 2 Grupos:</strong> O torneio começará diretamente nas <strong>Semifinais</strong>.</li>
                            <li><strong>Crie 4 Grupos:</strong> O torneio começará nas <strong>Quartas de Final</strong>.</li>
                        </ul>
                    </div>

                    <div id="notification-area" class="mb-4"></div>
                    <div class="space-y-4 md:flex md:space-y-0 md:space-x-4">
                        <div class="flex-1">
                            <label for="group-name-input" class="block mb-2 text-sm font-medium text-gray-700">Nome do Grupo (Ex: A, B, C )</label>
                            <input type="text" id="group-name-input" class="bg-gray-100 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-red-500 focus:border-red-500 block w-full p-2.5" placeholder="Grupo A">
                        </div>
                        <div class="flex-[3]">
                            <label for="team-names-input" class="block mb-2 text-sm font-medium text-gray-700">Nomes dos Times (separados por vírgula)</label>
                            <input type="text" id="team-names-input" class="bg-gray-100 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-red-500 focus:border-red-500 block w-full p-2.5" placeholder="Time 1, Time 2, Time 3, Time 4">
                        </div>
                        <div class="flex-shrink-0 self-end">
                            <div class="flex items-center space-x-2">
                                <button id="add-group-btn" class="w-full bg-red-600 hover:bg-red-700 text-white font-bold py-2.5 px-6 rounded-lg shadow-lg transition-transform transform hover:scale-105">
                                    Adicionar
                                </button>
                                <button id="reset-tournament-btn" class="bg-gray-600 hover:bg-gray-700 text-white font-bold py-2.5 px-6 rounded-lg shadow-lg transition-transform transform hover:scale-105">
                                    Resetar Tudo
                                </button>
                            </div>
                        </div>
                    </div>
                </section>
                <section id="group-stage" class="mb-12" style="display: none;">
                    <h2 class="text-3xl font-bold text-gray-900 border-b-2 border-red-500 pb-2 mb-6">Fase de Grupos</h2>
                    <div id="groups-container" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-2 gap-6"></div>
                    <div id="advance-btn-container" class="mt-8 text-center" style="display: none;">
                        <button id="advance-teams-btn" class="bg-red-600 hover:bg-red-700 text-white font-bold py-3 px-6 rounded-lg shadow-lg transition-transform transform hover:scale-105">
                            Gerar Eliminatórias
                        </button>
                    </div>
                </section>
                <section id="knockout-stage" style="display: none;">
                    <h2 class="text-3xl font-bold text-gray-900 border-b-2 border-red-500 pb-2 mb-8">Fase Eliminatória</h2>
                    <div id="knockout-container" class="flex flex-col md:flex-row justify-center items-stretch md:space-x-16 space-y-8 md:space-y-0 overflow-x-auto pb-8"></div>
                </section>
                 <section id="champion-section" class="text-center my-12" style="display: none;">
                    <div class="relative bg-white p-8 rounded-xl shadow-2xl border-4 border-amber-400 overflow-hidden">
                        <canvas id="confetti-canvas" class="absolute top-0 left-0 w-full h-full pointer-events-none"></canvas>
                        <div class="relative z-10">
                             <div class="flex justify-center items-center mb-4">
                               <svg class="w-16 h-16 text-amber-400 drop-shadow-lg" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                                  <path stroke-linecap="round" stroke-linejoin="round" d="M16.5 18.75h-9a9.75 9.75 0 01-4.973-1.803 1.875 1.875 0 01-1.227-2.738M19.197 14.21a1.875 1.875 0 01-1.227 2.738 9.75 9.75 0 01-4.973 1.803h-9M15 21h-6a.75.75 0 01-.75-.75v-2.25a.75.75 0 01.75-.75h6a.75.75 0 01.75.75V20.25a.75.75 0 01-.75.75zM12 2.25c-3.131 0-5.666 2.343-6.425 5.354.744-.56 1.684-.879 2.675-.879h7.5c.991 0 1.931.32 2.675.879C17.666 4.593 15.131 2.25 12 2.25zM12 9a.75.75 0 01-.75-.75V3a.75.75 0 011.5 0v5.25A.75.75 0 0112 9zM3.75 9.75a3 3 0 013-3h10.5a3 3 0 013 3v3.375a3 3 0 01-3 3H6.75a3 3 0 01-3-3V9.75z" />
                                </svg>
                            </div>
                            <h2 class="text-2xl font-bold text-gray-600 uppercase tracking-widest">O Grande Campeão</h2>
                            <p id="champion-name" class="text-5xl md:text-7xl font-bold text-transparent bg-clip-text bg-gradient-to-r from-red-600 to-amber-500 my-4"></p>
                        </div>
                    </div>
                </section>
            </main>
            <footer class="text-center mt-12 py-4 border-t border-gray-200">
                <p class="text-gray-500">&copy; 2025 - Plataforma de Torneio. Criado para a comunidade por Jerry Gleydison.</p>
            </footer>
        </div>
    </div>

    <!-- Modals -->
    <div id="confirmation-modal" class="fixed inset-0 bg-gray-900 bg-opacity-50 flex items-center justify-center z-50" style="display: none;">
        <div class="bg-white rounded-lg shadow-xl p-6 w-full max-w-sm">
            <p id="confirmation-message" class="text-lg text-gray-800 mb-6">Você tem certeza?</p>
            <div class="flex justify-end space-x-4">
                <button id="confirm-cancel-btn" class="px-4 py-2 bg-gray-300 hover:bg-gray-400 text-gray-800 rounded-lg">Cancelar</button>
                <button id="confirm-action-btn" class="px-4 py-2 bg-red-600 hover:bg-red-700 text-white rounded-lg">Confirmar</button>
            </div>
        </div>
    </div>
    
    <!-- Modal de Upload de Logo -->
    <div id="logo-upload-modal" class="fixed inset-0 bg-gray-900 bg-opacity-50 flex items-center justify-center z-50" style="display: none;">
        <div class="bg-white rounded-lg shadow-xl p-6 w-full max-w-sm text-center">
            <h3 class="text-lg font-bold mb-4">Escolher Escudo do Time</h3>
            <div class="mb-4">
                <img id="logo-preview" src="" alt="Pré-visualização do escudo" class="w-24 h-24 mx-auto rounded-full object-cover border mb-4 bg-gray-100">
                <input type="file" id="logo-file-input" class="block w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-red-50 file:text-red-700 hover:file:bg-red-100 cursor-pointer" accept="image/*">
            </div>
            <div class="flex justify-end space-x-4">
                <button id="cancel-logo-upload-btn" class="px-4 py-2 bg-gray-300 hover:bg-gray-400 text-gray-800 rounded-lg">Cancelar</button>
                <button id="confirm-logo-upload-btn" class="px-4 py-2 bg-red-600 hover:bg-red-700 text-white rounded-lg">Salvar</button>
            </div>
        </div>
    </div>
    
    <!-- Scripts Firebase -->
    <script type="module">
        // Import the functions you need from the SDKs you need
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import { getAuth, onAuthStateChanged, sendSignInLinkToEmail, isSignInWithEmailLink, signInWithEmailLink, signOut } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
        import { getFirestore, doc, getDoc, setDoc, deleteDoc } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

        // Your web app's Firebase configuration
        // REMINDER: Replace with your actual Firebase config
         const firebaseConfig = {
    apiKey: "AIzaSyADVsS_wCzlQv-mVRLf_tZOq7suWavbYTw",
    authDomain: "copa-play-ps4.firebaseapp.com",
    projectId: "copa-play-ps4",
    storageBucket: "copa-play-ps4.firebasestorage.app",
    messagingSenderId: "204861096387",
    appId: "1:204861096387:web:69fdef9e45f54eae487d76"
  };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // --- Variáveis Globais ---
        let tournamentData = { groups: {}, matches: {}, knockout: {} };
        let isKnockoutGenerated = false;
        let confirmCallback = null;
        let confettiAnimationId;
        let userId = null; // To store the logged-in user's ID
        const loadingOverlay = document.getElementById('loading-overlay');
        const loginStage = document.getElementById('login-stage');
        const appContainer = document.getElementById('app-container');

        // --- INICIALIZAÇÃO E AUTENTICAÇÃO ---
        document.addEventListener('DOMContentLoaded', () => {
            handleMagicLinkSignIn();
            setupEventListeners();
            
            onAuthStateChanged(auth, async (user) => {
                loadingOverlay.style.display = 'flex';
                if (user) {
                    // User is signed in
                    userId = user.uid;
                    loginStage.style.display = 'none';
                    appContainer.style.display = 'block';
                    updateAuthStatus(user);
                    await loadDataFromFirestore();
                } else {
                    // User is signed out
                    userId = null;
                    loginStage.style.display = 'block';
                    appContainer.style.display = 'none';
                    resetUIState();
                }
                loadingOverlay.style.display = 'none';
            });
        });
        
        async function handleMagicLinkSignIn() {
            if (isSignInWithEmailLink(auth, window.location.href)) {
                let email = window.localStorage.getItem('emailForSignIn');
                if (!email) {
                    email = window.prompt('Por favor, forneça seu e-mail para confirmação.');
                }
                loadingOverlay.style.display = 'flex';
                try {
                    await signInWithEmailLink(auth, email, window.location.href);
                    window.localStorage.removeItem('emailForSignIn');
                    // Clean the URL
                    window.history.replaceState({}, document.title, window.location.pathname);
                } catch (error) {
                    console.error("Erro ao entrar com link mágico:", error);
                    showNotification("Link inválido ou expirado. Tente novamente.", "error", "login-notification-area");
                } finally {
                    loadingOverlay.style.display = 'none';
                }
            }
        }

        async function sendMagicLink() {
            const emailInput = document.getElementById('email-input');
            const email = emailInput.value.trim();
            if(!email) return showNotification("Por favor, insira um e-mail.", "error", "login-notification-area");

            const actionCodeSettings = {
                url: window.location.href,
                handleCodeInApp: true,
            };

            loadingOverlay.style.display = 'flex';
            try {
                await sendSignInLinkToEmail(auth, email, actionCodeSettings);
                window.localStorage.setItem('emailForSignIn', email);
                showNotification(`Link de acesso enviado para ${email}! Verifique sua caixa de entrada.`, "success", "login-notification-area");
                emailInput.value = '';
            } catch (error) {
                console.error("Erro ao enviar link mágico:", error);
                showNotification("Ocorreu um erro. Verifique o e-mail e tente novamente.", "error", "login-notification-area");
            } finally {
                loadingOverlay.style.display = 'none';
            }
        }
        
        function signOutUser() {
            signOut(auth).catch(error => console.error("Erro ao sair:", error));
        }
        
        function updateAuthStatus(user) {
            const statusDiv = document.getElementById('auth-status');
            if (user) {
                statusDiv.innerHTML = `
                    <p class="font-medium">${user.email}</p>
                    <button id="sign-out-btn" class="text-red-600 hover:underline">Sair</button>
                `;
                document.getElementById('sign-out-btn').addEventListener('click', signOutUser);
            } else {
                statusDiv.innerHTML = '';
            }
        }
        
        function setupEventListeners() {
            document.getElementById('send-magic-link-btn').addEventListener('click', sendMagicLink);
            document.getElementById('add-group-btn').addEventListener('click', addGroup);
            document.getElementById('advance-teams-btn').addEventListener('click', advanceTeamsToKnockout);
            document.getElementById('reset-tournament-btn').addEventListener('click', resetTournament);
            document.getElementById('groups-container').addEventListener('input', handleGroupCardInput);
            document.getElementById('groups-container').addEventListener('click', handleGroupCardClick);
            document.getElementById('knockout-container').addEventListener('input', handleKnockoutInput);
            document.getElementById('confirm-cancel-btn').addEventListener('click', closeConfirmationModal);
            document.getElementById('confirm-action-btn').addEventListener('click', () => { if (confirmCallback) confirmCallback(); closeConfirmationModal(); });

            // Listeners do modal de logo
            document.getElementById('logo-file-input').addEventListener('change', previewLogo);
            document.getElementById('cancel-logo-upload-btn').addEventListener('click', closeLogoUploadModal);
            document.getElementById('confirm-logo-upload-btn').addEventListener('click', saveLogo);
        }
        
        function resetUIState() {
            tournamentData = { groups: {}, matches: {}, knockout: {} };
            isKnockoutGenerated = false;
            renderAll();
        }

        // --- LÓGICA DE DADOS (FIRESTORE) ---
        async function saveDataToFirestore() {
            if (!userId) return;
            loadingOverlay.style.display = 'flex';
            try {
                const userDocRef = doc(db, "tournaments", userId);
                await setDoc(userDocRef, { data: JSON.stringify(tournamentData) });
            } catch (error) {
                console.error("Erro ao salvar dados no Firestore:", error);
                showNotification("Não foi possível salvar os dados na nuvem.", "error");
            } finally {
                loadingOverlay.style.display = 'none';
            }
        }

        async function loadDataFromFirestore() {
            if (!userId) return;
            loadingOverlay.style.display = 'flex';
            try {
                const userDocRef = doc(db, "tournaments", userId);
                const docSnap = await getDoc(userDocRef);

                if (docSnap.exists()) {
                    const data = docSnap.data().data;
                    if(data){
                        tournamentData = JSON.parse(data);
                    } else {
                        tournamentData = { groups: {}, matches: {}, knockout: {} };
                    }
                } else {
                    tournamentData = { groups: {}, matches: {}, knockout: {} };
                }
            } catch (error) {
                 console.error("Erro ao carregar dados do Firestore:", error);
                 tournamentData = { groups: {}, matches: {}, knockout: {} };
                 showNotification("Não foi possível carregar seus dados.", "error");
            }
            
            try {
                renderAll();
            } catch (renderError) {
                console.error("Erro fatal durante a renderização:", renderError);
                appContainer.innerHTML = `<div class="text-center p-8 text-red-600">Ocorreu um erro grave ao exibir o torneio. Por favor, tente <button onclick="resetTournament()" class="underline font-bold">resetar os dados</button>. Erro: ${renderError.message}</div>`;
            } finally {
                loadingOverlay.style.display = 'none';
            }
        }
        
        function resetTournament() {
             showConfirmationModal("Tem certeza que deseja resetar todo o torneio? Todos os dados na nuvem serão perdidos.", async () => {
                 resetUIState(); // Reset local state first
                 if (!userId) return;
                 loadingOverlay.style.display = 'flex';
                 try {
                     const userDocRef = doc(db, "tournaments", userId);
                     await deleteDoc(userDocRef); // Or setDoc with empty data
                     showNotification("O torneio foi resetado.", "success");
                 } catch(e) {
                     console.error("Error resetting document: ", e);
                     showNotification("Erro ao resetar dados na nuvem.", "error");
                 } finally {
                     loadingOverlay.style.display = 'none';
                     resetUIState(); // Re-render the empty state
                 }
             });
        }
        
        // --- RENDERIZAÇÃO E LÓGICA DO TORNEIO (funções adaptadas para usar saveDataToFirestore) ---
        function renderAll() {
            isKnockoutGenerated = tournamentData.knockout && (tournamentData.knockout.quarterFinals?.length > 0 || tournamentData.knockout.semiFinals?.length > 0);
            if (tournamentData.groups && Object.keys(tournamentData.groups).length > 0) {
                document.getElementById('group-stage').style.display = 'block';
                document.getElementById('advance-btn-container').style.display = 'block';
            } else {
                 document.getElementById('group-stage').style.display = 'none';
                 document.getElementById('advance-btn-container').style.display = 'none';
            }
            if(isKnockoutGenerated) {
                document.getElementById('knockout-stage').style.display = 'block';
                renderKnockout();
            } else {
                document.getElementById('knockout-stage').style.display = 'none';
                document.getElementById('champion-section').style.display = 'none';
            }
            renderGroups();
        }

        function showConfirmationModal(message, callback) {
            document.getElementById('confirmation-message').textContent = message;
            confirmCallback = callback;
            document.getElementById('confirmation-modal').style.display = 'flex';
        }

        function closeConfirmationModal() {
            document.getElementById('confirmation-modal').style.display = 'none';
            confirmCallback = null;
        }

        function showNotification(message, type = 'error', areaId = 'notification-area') {
            const notificationArea = document.getElementById(areaId);
            if (!notificationArea) return;
            const bgColor = type === 'error' ? 'bg-red-500' : 'bg-green-500';
            const notification = `<div class="${bgColor} text-white text-sm font-bold px-4 py-3 rounded-lg relative" role="alert"><span class="block sm:inline">${message}</span></div>`;
            notificationArea.innerHTML = notification;
            setTimeout(() => { notificationArea.innerHTML = ''; }, 5000);
        }

        async function addGroup() {
            const groupNameInput = document.getElementById('group-name-input');
            const teamNamesInput = document.getElementById('team-names-input');
            const groupKey = groupNameInput.value.trim().toUpperCase().replace("GRUPO ", "");
            const teams = teamNamesInput.value.split(',').map(t => ({ name: t.trim(), logo: null })).filter(t => t.name);

            if (!groupKey) return showNotification("O nome do grupo é obrigatório.", "error");
            if (teams.length < 2) return showNotification("É necessário pelo menos 2 times.", "error");
            if (tournamentData.groups && tournamentData.groups[groupKey]) return showNotification(`O Grupo ${groupKey} já existe.`, "error");

            document.getElementById('group-stage').style.display = 'block';
            document.getElementById('advance-btn-container').style.display = 'block';
            if(!tournamentData.groups) tournamentData.groups = {};
            tournamentData.groups[groupKey] = { name: `Grupo ${groupKey}`, teams: teams };
            generateGroupMatches(groupKey);
            await saveDataToFirestore();
            renderGroups();
            groupNameInput.value = ''; teamNamesInput.value = ''; groupNameInput.focus();
        }

        function generateGroupMatches(groupKey) {
            const { teams } = tournamentData.groups[groupKey];
            if(!tournamentData.matches) tournamentData.matches = {};
            tournamentData.matches[groupKey] = [];
            for (let i = 0; i < teams.length; i++) {
                for (let j = i + 1; j < teams.length; j++) {
                    tournamentData.matches[groupKey].push({ teamA: teams[i], teamB: teams[j], scoreA: null, scoreB: null });
                }
            }
        }
        
        function calculateStandings(groupKey) {
            const teams = (tournamentData.groups[groupKey] && tournamentData.groups[groupKey].teams) ? tournamentData.groups[groupKey].teams : [];
            const matches = (tournamentData.matches && tournamentData.matches[groupKey]) ? tournamentData.matches[groupKey] : [];
            let standings = teams.map(team => ({ name: team.name, logo: team.logo, P: 0, J: 0, V: 0, E: 0, D: 0, GP: 0, GC: 0, SG: 0 }));
            matches.forEach(match => {
                if (match.scoreA === null || match.scoreB === null || isNaN(match.scoreA) || isNaN(match.scoreB)) return;
                const teamA = standings.find(t => t.name === match.teamA.name);
                const teamB = standings.find(t => t.name === match.teamB.name);
                if(!teamA || !teamB) return;
                teamA.J++; teamB.J++;
                teamA.GP += +match.scoreA; teamB.GP += +match.scoreB;
                teamA.GC += +match.scoreB; teamB.GC += +match.scoreA;
                teamA.SG = teamA.GP - teamA.GC; teamB.SG = teamB.GP - teamB.GC;
                if (+match.scoreA > +match.scoreB) { teamA.V++; teamB.D++; teamA.P += 3; } 
                else if (+match.scoreB > +match.scoreA) { teamB.V++; teamA.D++; teamB.P += 3; } 
                else { teamA.E++; teamB.E++; teamA.P += 1; teamB.P += 1; }
            });
            return standings.sort((a, b) => b.P - a.P || b.SG - a.SG || b.GP - a.GP || a.name.localeCompare(b.name));
        }

        function renderGroups() {
            const container = document.getElementById('groups-container');
            container.innerHTML = '';
            const sortedGroupKeys = tournamentData.groups ? Object.keys(tournamentData.groups).sort() : [];
            
            for (const groupKey of sortedGroupKeys) {
                const group = tournamentData.groups[groupKey];
                const standings = calculateStandings(groupKey);
                const matches = (tournamentData.matches && tournamentData.matches[groupKey]) ? tournamentData.matches[groupKey] : [];
                const groupCard = document.createElement('div');
                groupCard.className = 'bg-white p-5 rounded-xl shadow-lg border border-gray-200';
                groupCard.dataset.groupKey = groupKey;
                const editDisabled = isKnockoutGenerated ? 'disabled' : '';
                const editClasses = isKnockoutGenerated ? 'opacity-50 cursor-not-allowed' : 'text-gray-400 hover:text-red-600';
                
                const teamLogo = (team) => `<img src="${team.logo || `https://placehold.co/24x24/cccccc/000000?text=${team.name.charAt(0)}`}" alt="Escudo ${team.name}" class="w-6 h-6 rounded-full object-cover mr-2 inline-block">`;
                
                let matchesHtml = matches.map((match, index) => {
                    const currentTeamA = group.teams.find(t => t.name === match.teamA.name) || match.teamA;
                    const currentTeamB = group.teams.find(t => t.name === match.teamB.name) || match.teamB;
                    return `
                    <div class="flex items-center justify-between space-x-2 py-2 border-b border-gray-200 last:border-b-0">
                        <span class="flex-1 text-right flex items-center justify-end">
                            <span class="truncate">${currentTeamA.name}</span>
                            ${teamLogo(currentTeamA)}
                        </span>
                        <input type="number" min="0" class="score-input bg-gray-100 border border-gray-300 w-12 text-center rounded" data-match-index="${index}" data-team="A" value="${match.scoreA !== null ? match.scoreA : ''}" ${editDisabled}>
                        <span class="font-bold">vs</span>
                        <input type="number" min="0" class="score-input bg-gray-100 border border-gray-300 w-12 text-center rounded" data-match-index="${index}" data-team="B" value="${match.scoreB !== null ? match.scoreB : ''}" ${editDisabled}>
                        <span class="flex-1 text-left flex items-center">
                            ${teamLogo(currentTeamB)}
                            <span class="truncate">${currentTeamB.name}</span>
                        </span>
                    </div>`;
                }).join('');
                
                 groupCard.innerHTML = `
                    <div class="flex justify-between items-center mb-4">
                        <div class="group-title-container text-xl font-bold text-gray-900">${group.name}</div>
                        <div class="flex items-center space-x-1">
                            <button class="edit-group-name-btn p-1 ${editClasses}" data-group-key="${groupKey}" ${editDisabled} title="Editar Nome do Grupo">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 pointer-events-none" viewBox="0 0 20 20" fill="currentColor"><path d="M13.586 3.586a2 2 0 112.828 2.828l-.793.793-2.828-2.828.793-.793zM11.379 5.793L3 14.172V17h2.828l8.379-8.379-2.828-2.828z" /></svg>
                            </button>
                             <button class="delete-group-btn p-1 ${editClasses}" data-group-key="${groupKey}" ${editDisabled} title="Excluir Grupo">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 pointer-events-none" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm4 0a1 1 0 012 0v6a1 1 0 11-2 0V8z" clip-rule="evenodd" /></svg>
                            </button>
                        </div>
                    </div>
                    <div class="overflow-x-auto mb-4">
                        <table class="w-full text-sm text-left">
                              <thead class="bg-gray-100 text-gray-600 uppercase">
                                <tr>
                                    <th class="px-4 py-2">Time</th>
                                    <th class="px-2 py-2 text-center">P</th>
                                    <th class="px-2 py-2 text-center">J</th>
                                    <th class="px-2 py-2 text-center">V</th>
                                    <th class="px-2 py-2 text-center">E</th>
                                    <th class="px-2 py-2 text-center">D</th>
                                    <th class="px-2 py-2 text-center">SG</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${standings.map((t, i) => `<tr class="border-b ${i < 2 ? 'bg-green-50' : ''}">
                                    <td class="px-4 py-2 font-medium">
                                        <div class="flex justify-between items-center group">
                                            <div class="flex items-center">
                                                ${teamLogo(t)}
                                                <span>${i + 1}. ${t.name}</span>
                                            </div>
                                            <div class="flex items-center opacity-0 group-hover:opacity-100 transition-opacity">
                                                <button class="add-team-logo-btn p-1 ${editClasses}" data-team-name="${t.name}" ${editDisabled} title="Adicionar/Editar Escudo">
                                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 pointer-events-none" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M4 3a2 2 0 00-2 2v10a2 2 0 002 2h12a2 2 0 002-2V5a2 2 0 00-2-2H4zm12 12H4l4-8 3 6 2-4 3 6z" clip-rule="evenodd" /></svg>
                                                </button>
                                                <button class="edit-team-name-btn p-1 ${editClasses}" data-team-name="${t.name}" ${editDisabled} title="Editar Nome do Time">
                                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 pointer-events-none" viewBox="0 0 20 20" fill="currentColor"><path d="M13.586 3.586a2 2 0 112.828 2.828l-.793.793-2.828-2.828.793-.793zM11.379 5.793L3 14.172V17h2.828l8.379-8.379-2.828-2.828z" /></svg>
                                                </button>
                                                <button class="delete-team-btn p-1 ${editClasses}" data-team-name="${t.name}" ${editDisabled} title="Excluir Time">
                                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 pointer-events-none" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm4 0a1 1 0 012 0v6a1 1 0 11-2 0V8z" clip-rule="evenodd" /></svg>
                                                </button>
                                            </div>
                                        </div>
                                    </td>
                                    <td class="px-2 py-2 text-center font-bold">${t.P}</td>
                                    <td class="px-2 py-2 text-center">${t.J}</td>
                                    <td class="px-2 py-2 text-center">${t.V}</td>
                                    <td class="px-2 py-2 text-center">${t.E}</td>
                                    <td class="px-2 py-2 text-center">${t.D}</td>
                                    <td class="px-2 py-2 text-center">${t.SG}</td>
                                </tr>`).join('')}
                            </tbody>
                        </table>
                    </div>
                    <div>
                        <h4 class="font-bold text-md mb-2 text-center">Partidas</h4>
                        ${matchesHtml}
                    </div>
                    <div class="add-team-form mt-4 flex space-x-2 ${isKnockoutGenerated ? 'hidden' : ''}">
                        <input type="text" class="new-team-name-input flex-grow bg-gray-100 border border-gray-300 text-sm rounded-lg p-2 focus:ring-red-500 focus:border-red-500" placeholder="Adicionar novo time">
                        <button class="add-team-btn bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded-lg shadow-md transition-transform transform hover:scale-105">+</button>
                    </div>`;
                container.appendChild(groupCard);
            }
        }

        async function handleGroupCardInput(e) {
            if (!e.target.classList.contains('score-input')) return;
            const groupKey = e.target.closest('[data-group-key]').dataset.groupKey;
            const matchIndex = parseInt(e.target.dataset.matchIndex, 10);
            const team = e.target.dataset.team;
            const score = parseInt(e.target.value, 10);
            
            const match = tournamentData.matches[groupKey][matchIndex];
            if (team === 'A') match.scoreA = isNaN(score) ? null : score;
            else match.scoreB = isNaN(score) ? null : score;
            
            await saveDataToFirestore();
            renderGroups();
        }

        async function handleGroupCardClick(e) {
            const target = e.target.closest('button');
            if (!target) return;

            const groupKey = target.closest('[data-group-key]').dataset.groupKey;

            if (target.classList.contains('edit-group-name-btn')) {
                const newName = prompt("Digite o novo nome para o grupo:", tournamentData.groups[groupKey].name);
                if (newName && newName.trim() !== "") {
                    tournamentData.groups[groupKey].name = newName.trim();
                    await saveDataToFirestore();
                    renderGroups();
                }
            } else if (target.classList.contains('delete-group-btn')) {
                showConfirmationModal(`Tem certeza que deseja excluir o ${tournamentData.groups[groupKey].name}?`, async () => {
                    delete tournamentData.groups[groupKey];
                    delete tournamentData.matches[groupKey];
                    await saveDataToFirestore();
                    renderAll();
                });
            } else if (target.classList.contains('add-team-btn')) {
                const input = target.previousElementSibling;
                const newTeamName = input.value.trim();
                if (newTeamName) {
                    await addTeamToGroup(groupKey, newTeamName);
                    input.value = '';
                } else {
                    showNotification('O nome do novo time não pode estar vazio.', 'error');
                }
            } else if (target.classList.contains('edit-team-name-btn')) {
                const oldName = target.dataset.teamName;
                const newName = prompt(`Digite o novo nome para "${oldName}":`, oldName);
                if (newName && newName.trim() !== "" && newName.trim() !== oldName) {
                    await editTeamName(groupKey, oldName, newName.trim());
                }
            } else if (target.classList.contains('delete-team-btn')) {
                const teamName = target.dataset.teamName;
                showConfirmationModal(`Tem certeza que deseja excluir o time "${teamName}"? Todas as suas partidas no grupo serão removidas.`, async () => {
                    await deleteTeamFromGroup(groupKey, teamName);
                });
            } else if (target.classList.contains('add-team-logo-btn')) {
                const teamName = target.dataset.teamName;
                openLogoUploadModal(groupKey, teamName);
            }
        }
        
        // --- LÓGICA DO MODAL DE LOGO ---
        const logoUploadModal = document.getElementById('logo-upload-modal');
        const logoPreview = document.getElementById('logo-preview');
        const logoFileInput = document.getElementById('logo-file-input');

        function openLogoUploadModal(groupKey, teamName) {
            logoUploadModal.dataset.groupKey = groupKey;
            logoUploadModal.dataset.teamName = teamName;
            
            const team = tournamentData.groups[groupKey].teams.find(t => t.name === teamName);
            logoPreview.src = team.logo || 'https://placehold.co/96x96/efefef/333333?text=?'; // Placeholder
            logoFileInput.value = ''; // Reseta o input de arquivo
            
            logoUploadModal.style.display = 'flex';
        }

        function closeLogoUploadModal() {
            logoUploadModal.style.display = 'none';
        }

        function previewLogo(event) {
            const file = event.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = e => {
                    logoPreview.src = e.target.result;
                };
                reader.readAsDataURL(file);
            }
        }

        async function saveLogo() {
            const { groupKey, teamName } = logoUploadModal.dataset;
            const newLogoSrc = logoPreview.src;

            if (newLogoSrc.startsWith('https://placehold.co')) {
                 await setTeamLogo(groupKey, teamName, null);
            } else {
                 await setTeamLogo(groupKey, teamName, newLogoSrc);
            }
            closeLogoUploadModal();
        }

        async function addTeamToGroup(groupKey, newTeamName) {
            const group = tournamentData.groups[groupKey];
            if (group.teams.some(t => t.name === newTeamName)) {
                showNotification(`O time "${newTeamName}" já existe neste grupo.`, 'error');
                return;
            }
            group.teams.push({ name: newTeamName, logo: null });
            generateGroupMatches(groupKey); // Regenerate matches for the group
            await saveDataToFirestore();
            renderGroups();
        }

        async function editTeamName(groupKey, oldName, newName) {
            const group = tournamentData.groups[groupKey];
            const matches = tournamentData.matches[groupKey];

            if (group.teams.some(t => t.name === newName)) {
                showNotification(`O time "${newName}" já existe neste grupo.`, 'error');
                return;
            }

            const team = group.teams.find(t => t.name === oldName);
            if (team) {
                team.name = newName;
            }

            matches.forEach(match => {
                if (match.teamA.name === oldName) match.teamA.name = newName;
                if (match.teamB.name === oldName) match.teamB.name = newName;
            });

            await saveDataToFirestore();
            renderAll();
        }
        
        async function setTeamLogo(groupKey, teamName, logoDataUrl) {
            const group = tournamentData.groups[groupKey];
            const team = group.teams.find(t => t.name === teamName);
            if (team) {
                team.logo = logoDataUrl;
            }

            if (tournamentData.matches[groupKey]) {
                tournamentData.matches[groupKey].forEach(match => {
                    if (match.teamA.name === teamName) match.teamA.logo = logoDataUrl;
                    if (match.teamB.name === teamName) match.teamB.logo = logoDataUrl;
                });
            }
            
            await saveDataToFirestore();
            renderAll();
        }

        async function deleteTeamFromGroup(groupKey, teamNameToDelete) {
            const group = tournamentData.groups[groupKey];
            if (group.teams.length <= 2) {
                showNotification('Um grupo precisa ter no mínimo 2 times. Se desejar, exclua o grupo inteiro.', 'error');
                return;
            }

            group.teams = group.teams.filter(t => t.name !== teamNameToDelete);
            generateGroupMatches(groupKey);
            await saveDataToFirestore();
            renderGroups();
        }

        async function advanceTeamsToKnockout() {
            if (isKnockoutGenerated) return showNotification("A fase eliminatória já foi gerada.", "error");

            const allGroupKeys = Object.keys(tournamentData.groups).sort();
            if (allGroupKeys.length !== 2 && allGroupKeys.length !== 4) {
                return showNotification("Para gerar as eliminatórias automaticamente, crie exatamente 2 ou 4 grupos.", "error");
            }

            let qualifiedTeams = [];
            for (const groupKey of allGroupKeys) {
                const standings = calculateStandings(groupKey);
                if (standings.length < 2) {
                    return showNotification(`O Grupo ${groupKey} não tem times suficientes ou as partidas não foram preenchidas.`, "error");
                }
                qualifiedTeams.push(standings[0]); 
                qualifiedTeams.push(standings[1]);
            }
            
            tournamentData.knockout = { quarterFinals: [], semiFinals: [], final: [] };

            if (qualifiedTeams.length === 8) { // 4 Groups -> Start with Quarter-finals
                tournamentData.knockout.quarterFinals.push({ teamA: qualifiedTeams[0], teamB: qualifiedTeams[3], scoreA: null, scoreB: null }); // A1 vs B2
                tournamentData.knockout.quarterFinals.push({ teamA: qualifiedTeams[2], teamB: qualifiedTeams[1], scoreA: null, scoreB: null }); // B1 vs A2
                tournamentData.knockout.quarterFinals.push({ teamA: qualifiedTeams[4], teamB: qualifiedTeams[7], scoreA: null, scoreB: null }); // C1 vs D2
                tournamentData.knockout.quarterFinals.push({ teamA: qualifiedTeams[6], teamB: qualifiedTeams[5], scoreA: null, scoreB: null }); // D1 vs C2
            } else if (qualifiedTeams.length === 4) { // 2 Groups -> Start with Semi-finals
                tournamentData.knockout.semiFinals.push({ teamA: qualifiedTeams[0], teamB: qualifiedTeams[3], scoreA: null, scoreB: null }); // A1 vs B2
                tournamentData.knockout.semiFinals.push({ teamA: qualifiedTeams[2], teamB: qualifiedTeams[1], scoreA: null, scoreB: null }); // B1 vs A2
            }

            isKnockoutGenerated = true;
            await saveDataToFirestore();
            renderAll();
        }
        
        function updateKnockoutStages() {
            const { knockout } = tournamentData;
            if (!knockout) return;

            if (knockout.quarterFinals && knockout.quarterFinals.length > 0) {
                const quarterWinners = knockout.quarterFinals.map(match => 
                    (match.scoreA !== null && match.scoreB !== null && +match.scoreA !== +match.scoreB) 
                    ? (+match.scoreA > +match.scoreB ? match.teamA : match.teamB) 
                    : null
                );
                const numSemiFinals = knockout.quarterFinals.length / 2;
                for (let i = 0; i < numSemiFinals; i++) {
                    const teamA = quarterWinners[i * 2];
                    const teamB = quarterWinners[i * 2 + 1];
                    if (!knockout.semiFinals[i]) {
                        knockout.semiFinals[i] = { teamA: null, teamB: null, scoreA: null, scoreB: null };
                    }
                    if ((knockout.semiFinals[i].teamA?.name !== teamA?.name) || (knockout.semiFinals[i].teamB?.name !== teamB?.name)) {
                        knockout.semiFinals[i].teamA = teamA;
                        knockout.semiFinals[i].teamB = teamB;
                        knockout.semiFinals[i].scoreA = null;
                        knockout.semiFinals[i].scoreB = null;
                    }
                }
            }

            if (knockout.semiFinals && knockout.semiFinals.length > 0) {
                const semiWinners = knockout.semiFinals.map(match => 
                    (match.scoreA !== null && match.scoreB !== null && +match.scoreA !== +match.scoreB) 
                    ? (+match.scoreA > +match.scoreB ? match.teamA : match.teamB) 
                    : null
                );
                if (semiWinners.length >= 2) {
                    const finalTeamA = semiWinners[0];
                    const finalTeamB = semiWinners[1];
                    if (!knockout.final[0]) {
                        knockout.final[0] = { teamA: null, teamB: null, scoreA: null, scoreB: null };
                    }
                    if ((knockout.final[0].teamA?.name !== finalTeamA?.name) || (knockout.final[0].teamB?.name !== finalTeamB?.name)) {
                        knockout.final[0].teamA = finalTeamA;
                        knockout.final[0].teamB = finalTeamB;
                        knockout.final[0].scoreA = null;
                        knockout.final[0].scoreB = null;
                    }
                }
            }
        }
        
        function renderKnockout() {
            updateKnockoutStages();
            const container = document.getElementById('knockout-container');
            container.innerHTML = '';
            const rounds = ['quarterFinals', 'semiFinals', 'final'];
            const roundTitles = { quarterFinals: 'Quartas de Final', semiFinals: 'Semifinais', final: 'Final' };
            const teamLogo = (team) => `<img src="${team.logo || `https://placehold.co/24x24/cccccc/000000?text=${team.name.charAt(0)}`}" alt="Escudo ${team.name}" class="w-6 h-6 rounded-full object-cover mr-2">`;
            for (const roundName of rounds) {
                const roundData = tournamentData.knockout[roundName] || [];
                if(roundData.length === 0) continue;
                const roundDiv = document.createElement('div');
                roundDiv.className = 'round flex flex-col justify-center space-y-12';
                roundDiv.innerHTML = `<h3 class="text-xl font-bold text-center">${roundTitles[roundName]}</h3>`;
                roundData.forEach((match, index) => {
                    const winner = (match.scoreA !== null && match.scoreB !== null && +match.scoreA !== +match.scoreB) ? (+match.scoreA > +match.scoreB ? match.teamA : match.teamB) : null;
                    const teamADisplay = match.teamA ? `<div class="flex items-center">${teamLogo(match.teamA)} <span class="truncate">${match.teamA.name}</span></div>` : 'A definir';
                    const teamBDisplay = match.teamB ? `<div class="flex items-center">${teamLogo(match.teamB)} <span class="truncate">${match.teamB.name}</span></div>` : 'A definir';
                    roundDiv.innerHTML += `
                        <div class="matchup bg-white p-3 rounded-lg shadow w-64" data-round="${roundName}" data-match-index="${index}">
                             <div class="flex items-center justify-between">
                                 <div class="flex-1 ${winner && winner.name === match.teamA?.name ? 'winner' : ''}">${teamADisplay}</div>
                                <input type="number" min="0" class="knockout-score-input w-12 text-center bg-gray-100 border rounded" data-team="A" value="${match.scoreA !== null ? match.scoreA : ''}" ${!match.teamA || !match.teamB ? 'disabled' : ''}>
                             </div>
                             <div class="text-center text-xs text-gray-500 my-1">vs</div>
                            <div class="flex items-center justify-between">
                                 <div class="flex-1 ${winner && winner.name === match.teamB?.name ? 'winner' : ''}">${teamBDisplay}</div>
                                <input type="number" min="0" class="knockout-score-input w-12 text-center bg-gray-100 border rounded" data-team="B" value="${match.scoreB !== null ? match.scoreB : ''}" ${!match.teamA || !match.teamB ? 'disabled' : ''}>
                             </div>
                        </div>`;
                });
                container.appendChild(roundDiv);
            }
            const finalMatch = tournamentData.knockout.final && tournamentData.knockout.final[0];
            if (finalMatch && finalMatch.scoreA !== null && finalMatch.scoreB !== null && +finalMatch.scoreA !== +finalMatch.scoreB) {
                const champion = +finalMatch.scoreA > +finalMatch.scoreB ? finalMatch.teamA : finalMatch.teamB;
                document.getElementById('champion-name').innerHTML = `<div class="flex items-center justify-center">${teamLogo(champion)}<span>${champion.name}</span></div>`;
                document.getElementById('champion-section').style.display = 'block';
                triggerConfetti();
            } else {
                 document.getElementById('champion-section').style.display = 'none';
                 if(confettiAnimationId) cancelAnimationFrame(confettiAnimationId);
            }
        }

        async function handleKnockoutInput(e) {
             if (!e.target.classList.contains('knockout-score-input')) return;
             const matchupDiv = e.target.closest('.matchup');
             const round = matchupDiv.dataset.round;
             const matchIndex = parseInt(matchupDiv.dataset.matchIndex, 10);
             const team = e.target.dataset.team;
             const score = parseInt(e.target.value, 10);
             const match = tournamentData.knockout[round][matchIndex];
             if (team === 'A') match.scoreA = isNaN(score) ? null : score;
             else match.scoreB = isNaN(score) ? null : score;
             await saveDataToFirestore();
             renderKnockout();
        }

        function triggerConfetti() {
            if (confettiAnimationId) cancelAnimationFrame(confettiAnimationId);
            const canvas = document.getElementById('confetti-canvas');
            const ctx = canvas.getContext('2d');
            let particles = [];
            const particleCount = 200;
            const colors = ["#ef4444", "#f97316", "#eab308", "#84cc16", "#22c55e", "#14b8a6", "#06b6d4", "#3b82f6", "#8b5cf6"];
            function setupCanvas() {
                canvas.width = canvas.offsetWidth;
                canvas.height = canvas.offsetHeight;
            }
            class ConfettiParticle {
                constructor() {
                    this.x = Math.random() * canvas.width;
                    this.y = Math.random() * canvas.height - canvas.height;
                    this.size = Math.random() * 10 + 5;
                    this.speed = Math.random() * 5 + 2;
                    this.gravity = 0.1;
                    this.color = colors[Math.floor(Math.random() * colors.length)];
                    this.rotation = Math.random() * 360;
                    this.rotationSpeed = Math.random() * 4 - 2;
                }
                update() {
                    this.y += this.speed;
                    this.speed += this.gravity;
                    this.x += Math.sin(this.y / 20) * 2;
                    this.rotation += this.rotationSpeed;
                    if (this.y > canvas.height) {
                        this.y = -this.size * 2;
                        this.x = Math.random() * canvas.width;
                        this.speed = Math.random() * 5 + 2;
                    }
                }
                draw() {
                    ctx.save();
                    ctx.translate(this.x, this.y);
                    ctx.rotate(this.rotation * Math.PI / 180);
                    ctx.fillStyle = this.color;
                    ctx.fillRect(-this.size / 2, -this.size / 2, this.size, this.size * 0.7);
                    ctx.restore();
                }
            }
            function initConfetti() {
                setupCanvas();
                particles = [];
                for (let i = 0; i < particleCount; i++) {
                    particles.push(new ConfettiParticle());
                }
            }
            function animateConfetti() {
                ctx.clearRect(0, 0, canvas.width, canvas.height);
                particles.forEach(p => { p.update(); p.draw(); });
                confettiAnimationId = requestAnimationFrame(animateConfetti);
            }
            initConfetti();
            animateConfetti();
            window.addEventListener('resize', initConfetti, { passive: true });
        }
    </script>
</body>
</html>

