<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Campeonato de Futebol Digital</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6; /* bg-gray-100 */
        }
        .matchup { position: relative; }
        .round .matchup:not(:last-child) { margin-bottom: 3rem; }
        .connector { position: absolute; width: 2rem; border-style: solid; border-color: #d1d5db; }
        .connector.top { height: 50%; top: 0; left: -2rem; border-width: 0 0 2px 2px; border-bottom-left-radius: 0.5rem; }
        .connector.bottom { height: 50%; bottom: 0; left: -2rem; border-width: 2px 0 0 2px; border-top-left-radius: 0.5rem; }
        .connector.line { width: 2rem; height: 2px; top: 50%; left: -2rem; background-color: #d1d5db; }
        .round-connector { position: absolute; left: -4rem; width: 2rem; height: calc(100% + 3rem); top: 50%; transform: translateY(-50%); border-style: solid; border-color: #d1d5db; border-width: 0 2px 0 0; }
        .winner { font-weight: 700; color: #b91c1c; }
    </style>
</head>
<body class="text-gray-800">

    <div id="loading-overlay" class="fixed inset-0 bg-white bg-opacity-75 flex items-center justify-center z-50">
        <p class="text-xl font-semibold text-gray-700">Carregando...</p>
    </div>

    <div class="container mx-auto p-4 md:p-8">
        <!-- Se√ß√£o de Autentica√ß√£o -->
        <div id="auth-container" style="display: none;">
             <div class="max-w-md mx-auto bg-white p-8 rounded-xl shadow-lg text-center">
                <img src="https://placehold.co/128x128/ef4444/ffffff?text=LOGO" alt="Logo do Torneio" class="mx-auto mb-4 h-24 w-24 rounded-full">
                <h1 class="text-2xl font-bold text-gray-900">Bem-vindo √† Copa Digital</h1>
                <p class="text-gray-600 mt-2 mb-6">Fa√ßa login ou cadastre-se com seu e-mail para gerenciar seu torneio.</p>
                <div id="auth-notification-area" class="mb-4"></div>
                <div class="space-y-4">
                    <input type="email" id="email-input" class="bg-gray-100 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-red-500 focus:border-red-500 block w-full p-2.5" placeholder="seuemail@exemplo.com">
                    <button id="send-login-link-btn" class="w-full bg-red-600 hover:bg-red-700 text-white font-bold py-2.5 px-6 rounded-lg shadow-md transition-transform transform hover:scale-105">
                        Enviar Link M√°gico
                    </button>
                </div>
            </div>
        </div>
        
        <!-- Conte√∫do Principal do App (inicialmente oculto) -->
        <div id="app-container" style="display: none;">
            <header class="text-center mb-10 relative">
                 <div id="user-info" class="absolute top-0 right-0 text-right text-sm"></div>

                <img src="https://placehold.co/128x128/ef4444/ffffff?text=LOGO" alt="Logo do Torneio" class="mx-auto mb-4 h-24 w-24 rounded-full">
                <h1 class="text-4xl md:text-5xl font-bold text-gray-900 tracking-tight">Copa Digital de E-Futebol</h1>
                <p id="tournament-mode-indicator" class="text-gray-600 mt-2 text-lg">Acompanhe a fase de grupos e as eliminat√≥rias!</p>
            </header>

            <main>
                <!-- Bot√£o de Compartilhar -->
                <section id="share-section" class="mb-8 text-center" style="display: none;">
                    <button id="share-tournament-btn" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-8 rounded-lg shadow-lg transition-transform transform hover:scale-105">
                        Compartilhar Torneio
                    </button>
                </section>
                
                <section id="setup-stage" class="mb-12 bg-white p-6 rounded-xl shadow-lg border border-gray-200">
                    <h2 class="text-3xl font-bold text-gray-900 border-b-2 border-red-500 pb-2 mb-6">Configurar Torneio</h2>
                    <div id="notification-area" class="mb-4"></div>
                    <div class="space-y-4 md:flex md:space-y-0 md:space-x-4">
                        <div class="flex-1">
                            <label for="group-name-input" class="block mb-2 text-sm font-medium text-gray-700">Nome do Grupo (Ex: A, B, C)</label>
                            <input type="text" id="group-name-input" class="bg-gray-100 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-red-500 focus:border-red-500 block w-full p-2.5" placeholder="Grupo A">
                        </div>
                        <div class="flex-[3]">
                            <label for="team-names-input" class="block mb-2 text-sm font-medium text-gray-700">Nomes dos Times (separados por v√≠rgula)</label>
                            <input type="text" id="team-names-input" class="bg-gray-100 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-red-500 focus:border-red-500 block w-full p-2.5" placeholder="Time 1, Time 2, Time 3, Time 4">
                        </div>
                        <div class="flex-shrink-0 self-end">
                            <div class="flex items-center space-x-2">
                                <button id="add-group-btn" class="w-full bg-red-600 hover:bg-red-700 text-white font-bold py-2.5 px-6 rounded-lg shadow-lg transition-transform transform hover:scale-105">
                                    Adicionar
                                </button>
                                <button id="reset-tournament-btn" class="bg-gray-600 hover:bg-gray-700 text-white font-bold py-2.5 px-6 rounded-lg shadow-lg transition-transform transform hover:scale-105">
                                    Resetar Tudo
                                </button>
                            </div>
                        </div>
                    </div>
                </section>
                <section id="group-stage" class="mb-12" style="display: none;">
                    <h2 class="text-3xl font-bold text-gray-900 border-b-2 border-red-500 pb-2 mb-6">Fase de Grupos</h2>
                    <div id="groups-container" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-2 gap-6"></div>
                    <div id="advance-btn-container" class="mt-8 text-center" style="display: none;">
                        <button id="advance-teams-btn" class="bg-red-600 hover:bg-red-700 text-white font-bold py-3 px-6 rounded-lg shadow-lg transition-transform transform hover:scale-105">
                            Gerar Eliminat√≥rias
                        </button>
                    </div>
                </section>
                <section id="knockout-stage" style="display: none;">
                    <h2 class="text-3xl font-bold text-gray-900 border-b-2 border-red-500 pb-2 mb-8">Fase Eliminat√≥ria</h2>
                    <div id="knockout-container" class="flex flex-col md:flex-row justify-center items-stretch md:space-x-16 space-y-8 md:space-y-0 overflow-x-auto pb-8"></div>
                </section>
                <section id="champion-section" class="text-center my-12" style="display: none;">
                    <div class="bg-white p-8 rounded-xl shadow-lg border-2 border-amber-400">
                        <h2 class="text-2xl font-bold text-gray-500 uppercase tracking-widest">üèÜ O Grande Campe√£o üèÜ</h2>
                        <p id="champion-name" class="text-5xl md:text-7xl font-bold text-red-700 my-4 animate-pulse"></p>
                    </div>
                </section>
            </main>
            <footer class="text-center mt-12 py-4 border-t border-gray-200">
                <p class="text-gray-500">&copy; 2024 - Plataforma de Torneio. Criado para a comunidade.</p>
            </footer>
        </div>
    </div>

    <!-- Modals -->
    <div id="confirmation-modal" class="fixed inset-0 bg-gray-900 bg-opacity-50 flex items-center justify-center z-50" style="display: none;">
        <div class="bg-white rounded-lg shadow-xl p-6 w-full max-w-sm">
            <p id="confirmation-message" class="text-lg text-gray-800 mb-6">Voc√™ tem certeza?</p>
            <div class="flex justify-end space-x-4">
                <button id="confirm-cancel-btn" class="px-4 py-2 bg-gray-300 hover:bg-gray-400 text-gray-800 rounded-lg">Cancelar</button>
                <button id="confirm-action-btn" class="px-4 py-2 bg-red-600 hover:bg-red-700 text-white rounded-lg">Confirmar</button>
            </div>
        </div>
    </div>
     <div id="share-modal" class="fixed inset-0 bg-gray-900 bg-opacity-50 flex items-center justify-center z-50" style="display: none;">
        <div class="bg-white rounded-lg shadow-xl p-6 w-full max-w-lg text-center">
            <h3 class="text-2xl font-bold mb-4">Link para Visualiza√ß√£o</h3>
            <p class="text-gray-600 mb-4">Envie este link para os participantes. Eles poder√£o ver o torneio, mas n√£o poder√£o editar.</p>
            <input type="text" id="share-link-input" class="w-full bg-gray-100 border border-gray-300 p-2 rounded-lg text-center" readonly>
            <div class="mt-6 flex justify-center space-x-4">
                 <button id="copy-link-btn" class="px-6 py-2 bg-green-600 hover:bg-green-700 text-white rounded-lg">Copiar Link</button>
                <button id="close-share-modal-btn" class="px-6 py-2 bg-gray-300 hover:bg-gray-400 text-gray-800 rounded-lg">Fechar</button>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, onAuthStateChanged, sendSignInLinkToEmail, isSignInWithEmailLink, signInWithEmailLink, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, setDoc, deleteDoc, setLogLevel, collection, addDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- Vari√°veis Globais ---
        let tournamentData = { groups: {}, matches: {}, knockout: {} };
        let isKnockoutGenerated = false;
        let confirmCallback = null;
        let auth, db, userId;
        let isReadOnly = false;
        const loadingOverlay = document.getElementById('loading-overlay');

        // --- INICIALIZA√á√ÉO E AUTENTICA√á√ÉO ---
        document.addEventListener('DOMContentLoaded', () => {
            const firebaseConfig = {
                apiKey: "AIzaSyADVsS_wCzlQv-mVRLf_tZOq7suWavbYTw",
                 authDomain: "copa-play-ps4.firebaseapp.com",
                projectId: "copa-play-ps4",
                storageBucket: "copa-play-ps4.firebasestorage.app",
                messagingSenderId: "204861096387",
                appId: "1:204861096387:web:69fdef9e45f54eae487d76"
            };

            if (!firebaseConfig || !firebaseConfig.apiKey) {
                document.body.innerHTML = '<div class="text-center p-8 text-red-600">Erro: Configura√ß√£o do Firebase n√£o encontrada.</div>';
                return;
            }
            const app = initializeApp(firebaseConfig);
            auth = getAuth(app);
            db = getFirestore(app);
            setLogLevel('debug');
            
            const urlParams = new URLSearchParams(window.location.search);
            const viewTournamentId = urlParams.get('view');
            
            if (viewTournamentId) {
                isReadOnly = true;
                loadPublicData(viewTournamentId);
            } else {
                handleLoginRedirect();
                onAuthStateChanged(auth, user => {
                    const authContainer = document.getElementById('auth-container');
                    const appContainer = document.getElementById('app-container');
                    if (user) {
                        userId = user.uid;
                        authContainer.style.display = 'none';
                        appContainer.style.display = 'block';
                        document.getElementById('share-section').style.display = 'block';
                        updateUserInfo(user);
                        loadPrivateData();
                    } else {
                        userId = null;
                        authContainer.style.display = 'block';
                        appContainer.style.display = 'none';
                        resetUIState();
                        loadingOverlay.style.display = 'none';
                    }
                });
            }
            setupEventListeners();
        });

        function setupEventListeners() {
            document.getElementById('send-login-link-btn').addEventListener('click', sendLoginLink);
            document.getElementById('add-group-btn').addEventListener('click', addGroup);
            document.getElementById('advance-teams-btn').addEventListener('click', advanceTeamsToKnockout);
            document.getElementById('reset-tournament-btn').addEventListener('click', resetTournament);
            document.getElementById('groups-container').addEventListener('click', handleGroupCardClick);
            document.getElementById('confirm-cancel-btn').addEventListener('click', closeConfirmationModal);
            document.getElementById('confirm-action-btn').addEventListener('click', () => { if (confirmCallback) confirmCallback(); closeConfirmationModal(); });
            document.getElementById('share-tournament-btn').addEventListener('click', shareTournament);
            document.getElementById('close-share-modal-btn').addEventListener('click', () => document.getElementById('share-modal').style.display = 'none');
            document.getElementById('copy-link-btn').addEventListener('click', copyShareLink);
        }
        
        async function handleLoginRedirect() {
             if (isSignInWithEmailLink(auth, window.location.href)) {
                let email = window.localStorage.getItem('emailForSignIn');
                if (!email) email = window.prompt('Por favor, forne√ßa seu e-mail para confirma√ß√£o');
                try {
                    await signInWithEmailLink(auth, email, window.location.href);
                    window.localStorage.removeItem('emailForSignIn');
                    window.history.replaceState({}, document.title, window.location.pathname);
                } catch (error) { showNotification("N√£o foi poss√≠vel fazer login. O link pode ser inv√°lido ou ter expirado.", 'error', 'auth-notification-area'); }
            }
        }
        
        async function sendLoginLink() {
            const email = document.getElementById('email-input').value.trim();
            if (!email) return showNotification('Por favor, insira um e-mail v√°lido.', 'error', 'auth-notification-area');
            const actionCodeSettings = { url: window.location.href, handleCodeInApp: true };
            try {
                await sendSignInLinkToEmail(auth, email, actionCodeSettings);
                window.localStorage.setItem('emailForSignIn', email);
                showNotification(`Link de login enviado para ${email}. Verifique sua caixa de entrada!`, 'success', 'auth-notification-area');
            } catch (error) { showNotification('Ocorreu um erro ao enviar o link. Tente novamente.', 'error', 'auth-notification-area'); }
        }

        function updateUserInfo(user) {
            const userInfoDiv = document.getElementById('user-info');
            userInfoDiv.innerHTML = `<p class="font-semibold">${user.email}</p><button id="logout-btn" class="text-red-600 hover:underline">Sair</button>`;
            document.getElementById('logout-btn').addEventListener('click', () => signOut(auth));
        }
        
        function resetUIState() {
            tournamentData = { groups: {}, matches: {}, knockout: {} };
            isKnockoutGenerated = false;
            renderAll();
        }

        // --- L√ìGICA DE DADOS (FIRESTORE) ---
        async function savePrivateData() {
            if (!userId) return;
            // NOTE: The __app_id variable is specific to the dev environment. For a standalone app, you might hardcode an ID or handle it differently.
            const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
            const docRef = doc(db, 'artifacts', appId, 'users', userId, 'data', 'mainTournament');
            try {
                await setDoc(docRef, { ...tournamentData, ownerId: userId });
            } catch (error) { console.error("Erro ao salvar dados:", error); showNotification("N√£o foi poss√≠vel salvar os dados.", "error"); }
        }

        async function loadPrivateData() {
            loadingOverlay.style.display = 'flex';
            if (!userId) return;
            const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
            const docRef = doc(db, 'artifacts', appId, 'users', userId, 'data', 'mainTournament');
            const docSnap = await getDoc(docRef);
            if (docSnap.exists()) {
                tournamentData = docSnap.data();
            } else {
                tournamentData = { groups: {}, matches: {}, knockout: {}, ownerId: userId };
            }
            renderAll();
            loadingOverlay.style.display = 'none';
        }

        async function loadPublicData(tournamentId) {
            loadingOverlay.style.display = 'flex';
            const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
            const docRef = doc(db, 'artifacts', appId, 'public/data/tournaments', tournamentId);
            try {
                const docSnap = await getDoc(docRef);
                if (docSnap.exists()) {
                    tournamentData = docSnap.data();
                    document.getElementById('auth-container').style.display = 'none';
                    document.getElementById('app-container').style.display = 'block';
                    renderAll();
                } else {
                    document.body.innerHTML = `<div class="text-center p-8 text-red-600">Torneio n√£o encontrado. O link pode estar incorreto.</div>`;
                }
            } catch (error) {
                 document.body.innerHTML = `<div class="text-center p-8 text-red-600">Erro ao carregar o torneio.</div>`;
            } finally {
                loadingOverlay.style.display = 'none';
            }
        }

        async function resetTournament() {
             showConfirmationModal("Tem certeza que deseja resetar todo o torneio? Todos os dados ser√£o perdidos.", async () => {
                tournamentData = { groups: {}, matches: {}, knockout: {}, ownerId: userId };
                await savePrivateData();
                resetUIState();
                showNotification("O torneio foi resetado.", "success");
            });
        }
        
        async function shareTournament() {
            const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
            const publicId = tournamentData.publicId || doc(collection(db, '_')).id;
            const publicDocRef = doc(db, 'artifacts', appId, 'public/data/tournaments', publicId);
            
            try {
                await setDoc(publicDocRef, { ...tournamentData, lastUpdated: serverTimestamp() });
                if (!tournamentData.publicId) {
                    tournamentData.publicId = publicId;
                    await savePrivateData();
                }
                const shareLink = `${window.location.origin}${window.location.pathname}?view=${publicId}`;
                const linkInput = document.getElementById('share-link-input');
                linkInput.value = shareLink;
                document.getElementById('share-modal').style.display = 'flex';
                document.getElementById('share-tournament-btn').textContent = "Atualizar Link P√∫blico";
            } catch (error) {
                console.error("Erro ao compartilhar:", error);
                showNotification("N√£o foi poss√≠vel compartilhar o torneio.", "error");
            }
        }
        
        function copyShareLink() {
            const linkInput = document.getElementById('share-link-input');
            linkInput.select();
            document.execCommand('copy');
            showNotification("Link copiado para a √°rea de transfer√™ncia!", "success");
        }

        // --- RENDERIZA√á√ÉO E L√ìGICA DO TORNEIO ---
        function renderAll() {
            isKnockoutGenerated = tournamentData.knockout && tournamentData.knockout.quarterFinals && tournamentData.knockout.quarterFinals.length > 0;
            if (tournamentData.groups && Object.keys(tournamentData.groups).length > 0) {
                document.getElementById('group-stage').style.display = 'block';
                document.getElementById('advance-btn-container').style.display = 'block';
            } else {
                 document.getElementById('group-stage').style.display = 'none';
                document.getElementById('advance-btn-container').style.display = 'none';
            }
            if(isKnockoutGenerated) {
                document.getElementById('knockout-stage').style.display = 'block';
                renderKnockout();
            } else {
                document.getElementById('knockout-stage').style.display = 'none';
            }
             if (tournamentData.publicId) {
                document.getElementById('share-tournament-btn').textContent = "Atualizar Link P√∫blico";
            }
            renderGroups();
            if (isReadOnly) enterReadOnlyMode();
        }

        function enterReadOnlyMode() {
            document.getElementById('setup-stage').style.display = 'none';
            document.getElementById('advance-btn-container').style.display = 'none';
            document.getElementById('user-info').style.display = 'none';
            document.getElementById('share-section').style.display = 'none';
            document.getElementById('tournament-mode-indicator').textContent = "Modo de Visualiza√ß√£o";
            document.querySelectorAll('input, button').forEach(el => {
                if(!['confirm-cancel-btn', 'confirm-action-btn', 'close-share-modal-btn', 'copy-link-btn'].includes(el.id)){
                    el.disabled = true;
                }
            });
             document.querySelectorAll('.edit-group-name-btn, .delete-group-btn, .edit-team-name-btn, .remove-team-btn, .add-team-form').forEach(el => el.remove());
        }

        function showConfirmationModal(message, callback) {
            document.getElementById('confirmation-message').textContent = message;
            confirmCallback = callback;
            document.getElementById('confirmation-modal').style.display = 'flex';
        }

        function closeConfirmationModal() {
            document.getElementById('confirmation-modal').style.display = 'none';
            confirmCallback = null;
        }

        function showNotification(message, type = 'error', areaId = 'notification-area') {
            const notificationArea = document.getElementById(areaId);
            if (!notificationArea) return;
            const bgColor = type === 'error' ? 'bg-red-500' : 'bg-green-500';
            const notification = `<div class="${bgColor} text-white text-sm font-bold px-4 py-3 rounded-lg relative" role="alert"><span class="block sm:inline">${message}</span></div>`;
            notificationArea.innerHTML = notification;
            setTimeout(() => { notificationArea.innerHTML = ''; }, 5000);
        }

        function addGroup() {
            const groupNameInput = document.getElementById('group-name-input');
            const teamNamesInput = document.getElementById('team-names-input');
            const groupKey = groupNameInput.value.trim().toUpperCase().replace("GRUPO ", "");
            const teams = teamNamesInput.value.split(',').map(t => t.trim()).filter(t => t);

            if (!groupKey || teams.length < 2 || (tournamentData.groups && tournamentData.groups[groupKey])) return;
            document.getElementById('group-stage').style.display = 'block';
            document.getElementById('advance-btn-container').style.display = 'block';
            if(!tournamentData.groups) tournamentData.groups = {};
            tournamentData.groups[groupKey] = { name: `Grupo ${groupKey}`, teams: teams };
            generateGroupMatches(groupKey);
            renderGroups();
            savePrivateData();
            groupNameInput.value = ''; teamNamesInput.value = ''; groupNameInput.focus();
        }

        function generateGroupMatches(groupKey) {
            const { teams } = tournamentData.groups[groupKey];
            if(!tournamentData.matches) tournamentData.matches = {};
            tournamentData.matches[groupKey] = [];
            for (let i = 0; i < teams.length; i++) {
                for (let j = i + 1; j < teams.length; j++) {
                    tournamentData.matches[groupKey].push({ teamA: teams[i], teamB: teams[j], scoreA: null, scoreB: null });
                }
            }
        }
        
        function calculateStandings(groupKey) {
            const teams = (tournamentData.groups[groupKey] && tournamentData.groups[groupKey].teams) ? tournamentData.groups[groupKey].teams : [];
            const matches = (tournamentData.matches && tournamentData.matches[groupKey]) ? tournamentData.matches[groupKey] : [];
            let standings = teams.map(name => ({ name, P: 0, J: 0, V: 0, E: 0, D: 0, GP: 0, GC: 0, SG: 0 }));
            matches.forEach(match => {
                if (match.scoreA === null || match.scoreB === null || isNaN(match.scoreA) || isNaN(match.scoreB)) return;
                const teamA = standings.find(t => t.name === match.teamA);
                const teamB = standings.find(t => t.name === match.teamB);
                if(!teamA || !teamB) return;
                teamA.J++; teamB.J++;
                teamA.GP += match.scoreA; teamB.GP += match.scoreB;
                teamA.GC += match.scoreB; teamB.GC += match.scoreA;
                teamA.SG = teamA.GP - teamA.GC; teamB.SG = teamB.GP - teamB.GC;
                if (match.scoreA > match.scoreB) { teamA.V++; teamB.D++; teamA.P += 3; } 
                else if (match.scoreB > match.scoreA) { teamB.V++; teamA.D++; teamB.P += 3; } 
                else { teamA.E++; teamB.E++; teamA.P += 1; teamB.P += 1; }
            });
            return standings.sort((a, b) => b.P - a.P || b.SG - a.SG || b.GP - a.GP);
        }

        function renderGroups() {
            const container = document.getElementById('groups-container');
            container.innerHTML = '';
            const sortedGroupKeys = tournamentData.groups ? Object.keys(tournamentData.groups).sort() : [];
            
            for (const groupKey of sortedGroupKeys) {
                const group = tournamentData.groups[groupKey];
                const standings = calculateStandings(groupKey);
                const matches = (tournamentData.matches && tournamentData.matches[groupKey]) ? tournamentData.matches[groupKey] : [];
                const groupCard = document.createElement('div');
                groupCard.className = 'bg-white p-5 rounded-xl shadow-lg border border-gray-200';
                groupCard.dataset.groupKey = groupKey;
                const editDisabled = isKnockoutGenerated || isReadOnly ? 'disabled' : '';
                const editClasses = isKnockoutGenerated || isReadOnly ? 'opacity-50 cursor-not-allowed' : 'text-gray-400 hover:text-red-600';
                
                let matchesHtml = matches.map((match, index) => `
                    <div class="flex items-center justify-between space-x-2 py-2 border-b border-gray-200 last:border-b-0">
                        <span class="flex-1 text-right">${match.teamA}</span>
                        <input type="number" min="0" class="score-input bg-gray-100 border border-gray-300 w-12 text-center rounded" data-match-index="${index}" data-team="A" value="${match.scoreA !== null ? match.scoreA : ''}" ${editDisabled}>
                        <span class="font-bold">vs</span>
                        <input type="number" min="0" class="score-input bg-gray-100 border border-gray-300 w-12 text-center rounded" data-match-index="${index}" data-team="B" value="${match.scoreB !== null ? match.scoreB : ''}" ${editDisabled}>
                        <span class="flex-1 text-left">${match.teamB}</span>
                    </div>`).join('');
                
                 groupCard.innerHTML = `
                    <div class="flex justify-between items-center mb-4">
                        <div class="group-title-container text-xl font-bold text-gray-900">${group.name}</div>
                        ${!isReadOnly ? `<div class="flex items-center space-x-1">
                            <button class="edit-group-name-btn p-1 ${editClasses}" data-group-key="${groupKey}" ${editDisabled}>
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 pointer-events-none" viewBox="0 0 20 20" fill="currentColor"><path d="M17.414 2.586a2 2 0 00-2.828 0L7 10.172V13h2.828l7.586-7.586a2 2 0 000-2.828z" /><path fill-rule="evenodd" d="M2 6a2 2 0 012-2h4a1 1 0 010 2H4v10h10v-4a1 1 0 112 0v4a2 2 0 01-2 2H4a2 2 0 01-2-2V6z" clip-rule="evenodd" /></svg>
                            </button>
                            <button class="delete-group-btn p-1 ${editClasses}" data-group-key="${groupKey}" ${editDisabled}>
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 pointer-events-none" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" /></svg>
                            </button>
                        </div>` : ''}
                    </div>
                    <div class="overflow-x-auto mb-4">
                        <table class="w-full text-sm text-left">
                            <thead class="text-xs text-gray-500 uppercase bg-gray-50"><tr><th class="px-3 py-2">#</th><th class="px-3 py-2">Time</th><th class="px-3 py-2 text-center">P</th><th class="px-3 py-2 text-center">J</th><th class="px-3 py-2 text-center">V</th><th class="px-3 py-2 text-center">E</th><th class="px-3 py-2 text-center">D</th><th class="px-3 py-2 text-center">GP</th><th class="px-3 py-2 text-center">GC</th><th class="px-3 py-2 text-center">SG</th></tr></thead>
                            <tbody>
                                ${standings.map((team, index) => `
                                    <tr class="border-b border-gray-200 ${index < 2 ? 'bg-red-50' : ''}">
                                        <td class="px-3 py-2">${index + 1}</td>
                                        <td class="px-3 py-2 font-medium">
                                            <div class="flex justify-between items-center group team-name-container">
                                                <span>${team.name}</span>
                                                ${!isReadOnly ? `<div class="flex items-center">
                                                    <button class="edit-team-name-btn p-1 ${editClasses} opacity-0 group-hover:opacity-100 transition-opacity" data-team-name="${team.name}" ${editDisabled}>
                                                         <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 pointer-events-none" viewBox="0 0 20 20" fill="currentColor"><path d="M17.414 2.586a2 2 0 00-2.828 0L7 10.172V13h2.828l7.586-7.586a2 2 0 000-2.828z" /><path fill-rule="evenodd" d="M2 6a2 2 0 012-2h4a1 1 0 010 2H4v10h10v-4a1 1 0 112 0v4a2 2 0 01-2 2H4a2 2 0 01-2-2V6z" clip-rule="evenodd" /></svg>
                                                    </button>
                                                    <button class="remove-team-btn p-1 text-red-300 hover:text-red-600 opacity-0 group-hover:opacity-100 transition-opacity" data-team-name="${team.name}" ${editDisabled}>
                                                        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 pointer-events-none" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" /></svg>
                                                    </button>
                                                </div>` : ''}
                                            </div>
                                        </td>
                                        <td class="px-3 py-2 text-center">${team.P}</td><td class="px-3 py-2 text-center">${team.J}</td><td class="px-3 py-2 text-center">${team.V}</td><td class="px-3 py-2 text-center">${team.E}</td><td class="px-3 py-2 text-center">${team.D}</td><td class="px-3 py-2 text-center">${team.GP}</td><td class="px-3 py-2 text-center">${team.GC}</td><td class="px-3 py-2 text-center">${team.SG}</td>
                                    </tr>`).join('')}
                            </tbody>
                        </table>
                    </div>
                    <div><h4 class="font-semibold mb-2">Partidas</h4><div class="space-y-2">${matchesHtml}</div><button class="update-scores-btn mt-4 w-full bg-red-500 hover:bg-red-600 text-white font-bold py-2 px-4 rounded" ${editDisabled}>Atualizar Tabela</button></div>
                    ${!isReadOnly ? `<div class="add-team-form mt-4 pt-4 border-t border-gray-200 ${isKnockoutGenerated ? 'hidden' : ''}">
                        <p class="text-sm font-semibold mb-2 text-gray-700">Adicionar novo time</p>
                        <div class="flex space-x-2">
                            <input type="text" class="add-team-input flex-grow bg-gray-100 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-red-500 focus:border-red-500 block w-full p-2" placeholder="Nome do Time">
                            <button class="add-team-btn bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded">Adicionar</button>
                        </div>
                    </div>` : ''}
                `;
                container.appendChild(groupCard);
            }
        }
        
        function updateScoresAndRender(groupKey) {
            const groupCard = document.querySelector(`.bg-white[data-group-key="${groupKey}"]`);
            if(!groupCard) return;
            const inputs = groupCard.querySelectorAll(`.score-input`);
            inputs.forEach(input => {
                const { matchIndex, team } = input.dataset;
                const value = input.value === '' ? null : parseInt(input.value);
                if (tournamentData.matches[groupKey] && tournamentData.matches[groupKey][matchIndex]) {
                    tournamentData.matches[groupKey][matchIndex][`score${team}`] = value;
                }
            });
            renderGroups();
            savePrivateData();
        }

        function advanceTeamsToKnockout() {
            for (const groupKey in tournamentData.groups) { updateScoresAndRender(groupKey); }
            const groupKeys = Object.keys(tournamentData.groups);
            if (groupKeys.length < 2) return showNotification("√â necess√°rio pelo menos 2 grupos.");
            isKnockoutGenerated = true;
            const qualifiers = {};
            groupKeys.sort().forEach(groupKey => { qualifiers[groupKey] = calculateStandings(groupKey).slice(0, 2).map(t => t.name); });
            const qfMatches = [];
            for (let i = 0; i < Math.floor(groupKeys.length / 2) * 2; i += 2) {
                const key1 = groupKeys[i], key2 = groupKeys[i + 1];
                qfMatches.push({ teamA: qualifiers[key1][0], teamB: qualifiers[key2][1], scoreA: null, scoreB: null });
                qfMatches.push({ teamA: qualifiers[key2][0], teamB: qualifiers[key1][1], scoreA: null, scoreB: null });
            }
            tournamentData.knockout = {
                quarterFinals: qfMatches,
                semiFinals: Array.from({ length: qfMatches.length / 2 }, () => ({ teamA: "Vencedor", teamB: "Vencedor", scoreA: null, scoreB: null })),
                final: Array.from({ length: Math.max(0, qfMatches.length / 4) }, () => ({ teamA: "Vencedor", teamB: "Vencedor", scoreA: null, scoreB: null }))
            };
            savePrivateData();
            renderAll();
            document.getElementById('knockout-stage').scrollIntoView({ behavior: 'smooth' });
        }
        
        function handleGroupCardClick(e) {
            if (isReadOnly) return;
            const target = e.target;
            const groupCard = target.closest('.bg-white[data-group-key]');
            if(!groupCard) return;
            const groupKey = groupCard.dataset.groupKey;
            
            const buttonMappings = {
                '.edit-group-name-btn': () => showEditInput(target.closest('button').parentElement.previousElementSibling, 'group', groupKey),
                '.delete-group-btn': () => deleteGroup(groupKey),
                '.edit-team-name-btn': () => showEditInput(target.closest('button').parentElement.previousElementSibling, 'team', groupKey, target.closest('button').dataset.teamName),
                '.remove-team-btn': () => removeTeamFromGroup(groupKey, target.closest('button').dataset.teamName),
                '.update-scores-btn': () => updateScoresAndRender(groupKey),
                '.add-team-btn': () => addTeamToGroup(groupKey, target.previousElementSibling.value)
            };

            for(const selector in buttonMappings){
                if(target.closest(selector)){
                    buttonMappings[selector]();
                    return;
                }
            }
        }

        function showEditInput(container, type, groupKey, oldName = null) {
            if (document.querySelector('.edit-input-container')) { renderGroups(); }
            const originalValue = type === 'group' ? tournamentData.groups[groupKey].name.replace('Grupo ','') : oldName;
            container.innerHTML = `<div class="edit-input-container flex items-center gap-1">
                    <input type="text" class="bg-gray-200 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-red-500 focus:border-red-500 block w-full p-1.5" value="${originalValue}">
                    <button class="save-edit-btn p-1 text-green-600 hover:text-green-800"><svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 pointer-events-none" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd" /></svg></button>
                    <button class="cancel-edit-btn p-1 text-red-600 hover:text-red-800"><svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 pointer-events-none" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd" /></svg></button>
                </div>`;
            const input = container.querySelector('input');
            input.focus(); input.select();
            
            const saveFn = () => {
                const newValue = input.value.trim();
                if (type === 'group') { updateGroupName(groupKey, newValue.toUpperCase().replace("GRUPO ", "")); } 
                else { updateTeamName(groupKey, oldName, newValue); }
            };

            container.querySelector('.save-edit-btn').onclick = saveFn;
            container.querySelector('.cancel-edit-btn').onclick = () => renderGroups();
            input.onkeydown = (e) => { if (e.key === 'Enter') saveFn(); if (e.key === 'Escape') renderGroups(); };
        }

        function addTeamToGroup(groupKey, newTeamName) {
            const teamName = newTeamName.trim();
            if(!teamName) return showNotification("O nome do time n√£o pode ser vazio.");
            if(tournamentData.groups[groupKey].teams.includes(teamName)) return showNotification("Este time j√° est√° no grupo.");
            
            tournamentData.groups[groupKey].teams.push(teamName);
            generateGroupMatches(groupKey);
            savePrivateData();
            renderGroups();
        }

        function removeTeamFromGroup(groupKey, teamName) {
            if(tournamentData.groups[groupKey].teams.length <= 2) return showNotification("O grupo precisa ter pelo menos 2 times.");
            showConfirmationModal(`Tem certeza que deseja remover "${teamName}" do grupo?`, () => {
                tournamentData.groups[groupKey].teams = tournamentData.groups[groupKey].teams.filter(t => t !== teamName);
                generateGroupMatches(groupKey);
                savePrivateData();
                renderGroups();
            });
        }
        function deleteGroup(groupKey) {
            showConfirmationModal(`Tem certeza que deseja excluir o "${tournamentData.groups[groupKey].name}"?`, () => {
                delete tournamentData.groups[groupKey];
                delete tournamentData.matches[groupKey];
                savePrivateData();
                renderGroups();
            });
        }
        function updateGroupName(oldGroupKey, newGroupKey) {
            if (!newGroupKey) { return showNotification("O nome do grupo n√£o pode ser vazio."), renderGroups(); }
            if (newGroupKey === oldGroupKey) { return renderGroups(); }
            if (tournamentData.groups[newGroupKey]) { return showNotification("Esse nome de grupo j√° existe."), renderGroups(); }
            
            tournamentData.groups[newGroupKey] = { ...tournamentData.groups[oldGroupKey], name: `Grupo ${newGroupKey}` };
            delete tournamentData.groups[oldGroupKey];
            
            tournamentData.matches[newGroupKey] = [...tournamentData.matches[oldGroupKey]];
            delete tournamentData.matches[oldGroupKey];
            
            savePrivateData(); 
            renderGroups();
        }

        function updateTeamName(groupKey, oldName, newName) {
            if (!newName) { return showNotification("O nome do time n√£o pode ser vazio."), renderGroups(); }
            if (newName === oldName) { return renderGroups(); }
            if (tournamentData.groups[groupKey].teams.includes(newName)) { return showNotification("Esse nome de time j√° existe no grupo."), renderGroups(); }
            
            const teamIndex = tournamentData.groups[groupKey].teams.indexOf(oldName);
            if (teamIndex > -1) tournamentData.groups[groupKey].teams[teamIndex] = newName;
            
            tournamentData.matches[groupKey].forEach(match => {
                if (match.teamA === oldName) match.teamA = newName;
                if (match.teamB === oldName) match.teamB = newName;
            });
            savePrivateData();
            renderGroups();
        }

        function renderKnockout() {
            const container = document.getElementById('knockout-container');
            container.innerHTML = '';
            const data = tournamentData.knockout;
            if (!data || !data.quarterFinals || data.quarterFinals.length === 0) return;

            const qfWinners = data.quarterFinals.map(m => (m.scoreA !== null && m.scoreB !== null) ? (m.scoreA > m.scoreB ? m.teamA : m.teamB) : null);
            for (let i = 0; i < data.semiFinals.length; i++) {
                data.semiFinals[i].teamA = qfWinners[i * 2] || `Vencedor J${i * 2 + 1}`;
                data.semiFinals[i].teamB = qfWinners[i * 2 + 1] || `Vencedor J${i * 2 + 2}`;
            }
            const sfWinners = data.semiFinals.map(m => (m.scoreA !== null && m.scoreB !== null) ? (m.scoreA > m.scoreB ? m.teamA : m.teamB) : null);
            for (let i = 0; i < data.final.length; i++) {
                data.final[i].teamA = sfWinners[i * 2] || `Vencedor SF${i * 2 + 1}`;
                data.final[i].teamB = sfWinners[i * 2 + 1] || `Vencedor SF${i * 2 + 2}`;
            }

            const qfHtml = data.quarterFinals.map((m, i) => createMatchupHTML(m, 'quarterFinals', i, i % 2 === 0)).join('');
            const sfHtml = data.semiFinals.map((m, i) => createMatchupHTML(m, 'semiFinals', i, true, true)).join('');
            const finalHtml = data.final.map((m, i) => createMatchupHTML(m, 'final', i, false, true)).join('');

            container.innerHTML = createRoundHTML("Quartas de Final", qfHtml) + createRoundHTML("Semifinais", sfHtml, 'justify-around') + createRoundHTML("Final", finalHtml, 'justify-center');
            if (isReadOnly) document.querySelectorAll('.knockout-score-input').forEach(i => i.disabled = true);
            else document.querySelectorAll('.knockout-score-input').forEach(input => input.addEventListener('change', updateKnockoutScore));

            const finalMatch = data.final[0];
            if (finalMatch && finalMatch.scoreA !== null && finalMatch.scoreB !== null && !finalMatch.teamA.includes('Vencedor') && !finalMatch.teamB.includes('Vencedor')) {
                const champion = finalMatch.scoreA > finalMatch.scoreB ? finalMatch.teamA : finalMatch.teamB;
                tournamentData.knockout.champion = champion;
                showChampion(champion);
            } else {
                 document.getElementById('champion-section').style.display = 'none';
                 if(tournamentData.knockout) delete tournamentData.knockout.champion;
            }
        }
        function updateKnockoutScore(e) {
            const { round, matchIndex, team } = e.target.dataset;
            const value = e.target.value === '' ? null : parseInt(e.target.value);
            tournamentData.knockout[round][matchIndex][`score${team}`] = value;
            renderKnockout();
            savePrivateData();
        }
        function showChampion(name) {
             const section = document.getElementById('champion-section');
            const nameEl = document.getElementById('champion-name');
            nameEl.textContent = name;
            section.style.display = 'block';
            section.scrollIntoView({ behavior: 'smooth' });
        }
        function createRoundHTML(title, content, justifyClass = 'justify-between') {
            if (!content) return '';
            return `<div class="round flex flex-col ${justifyClass} min-w-[280px] relative"><h3 class="text-xl font-bold text-center mb-6 h-8">${title}</h3>${content}</div>`;
        }
        function createMatchupHTML(match, roundName, index, hasConnector, isLaterRound = false) {
             const teamAClass = match.scoreA !== null && match.scoreB !== null && match.scoreA > match.scoreB ? 'winner' : '';
             const teamBClass = match.scoreB !== null && match.scoreB !== null && match.scoreB > match.scoreA ? 'winner' : '';
             let connectorHtml = '';
             if (isLaterRound) connectorHtml += `<div class="connector line"></div><div class="round-connector"></div>`;
             else if (hasConnector) connectorHtml = `<div class="connector top"></div><div class="connector bottom"></div>`;
            return `
                <div class="matchup bg-white border border-gray-200 rounded-lg p-3 relative flex-grow-0">
                    ${connectorHtml}
                    <div class="flex items-center justify-between"><span class="flex-1 text-sm ${teamAClass}">${match.teamA}</span><input type="number" min="0" class="knockout-score-input bg-gray-100 border border-gray-300 w-10 text-center rounded mx-2" data-round="${roundName}" data-match-index="${index}" data-team="A" value="${match.scoreA !== null ? match.scoreA : ''}"></div>
                    <div class="my-2 border-t border-dashed border-gray-300"></div>
                    <div class="flex items-center justify-between"><span class="flex-1 text-sm ${teamBClass}">${match.teamB}</span><input type="number" min="0" class="knockout-score-input bg-gray-100 border border-gray-300 w-10 text-center rounded mx-2" data-round="${roundName}" data-match-index="${index}" data-team="B" value="${match.scoreB !== null ? match.scoreB : ''}"></div>
                </div>`;
        }
    </script>
</body>
</html>

