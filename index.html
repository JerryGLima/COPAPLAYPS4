<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Campeonato de Futebol Digital</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6; /* bg-gray-100 */
        }
        /* Estilos para desabilitar inputs para visitantes */
        .read-only-mode input, .read-only-mode button:not(.logo-btn ) {
            pointer-events: none;
            opacity: 0.7;
            background-color: #e5e7eb !important;
        }
        .read-only-mode .logo-btn { /* Permite clicar no logo mesmo em modo leitura */
             pointer-events: auto;
             opacity: 1;
        }
        .read-only-mode #setup-stage, 
        .read-only-mode #advance-btn-container,
        .read-only-mode .delete-group-btn {
            display: none !important;
        }
        /* Styles for knockout bracket connectors (optional) */
        .matchup { position: relative; }
        .round .matchup:not(:last-child ) { margin-bottom: 3rem; }
        .connector { position: absolute; width: 2rem; border-style: solid; border-color: #d1d5db; }
        .connector.top { height: 50%; top: 0; left: -2rem; border-width: 0 0 2px 2px; border-bottom-left-radius: 0.5rem; }
        .connector.bottom { height: 50%; bottom: 0; left: -2rem; border-width: 2px 0 0 2px; border-top-left-radius: 0.5rem; }
        .connector.line { width: 2rem; height: 2px; top: 50%; left: -2rem; background-color: #d1d5db; }
        .round-connector { position: absolute; left: -4rem; width: 2rem; height: calc(100% + 3rem); top: 50%; transform: translateY(-50%); border-style: solid; border-color: #d1d5db; border-width: 0 2px 0 0; }
        .winner { font-weight: 700; color: #b91c1c; }
    </style>
</head>
<body class="text-gray-800">

    <div id="loading-overlay" class="fixed inset-0 bg-white bg-opacity-75 flex items-center justify-center z-50">
        <p class="text-xl font-semibold text-gray-700">Carregando dados do torneio...</p>
    </div>

    <div class="container mx-auto p-4 md:p-8">
        
        <!-- Conteúdo Principal do App -->
        <div id="app-container">
            <header class="text-center mb-10 relative">
                <!-- LOGO SVG EMBUTIDO -->
                <div class="mx-auto mb-4 h-24 w-24 rounded-full bg-white shadow-md flex items-center justify-center">
                    <svg class="w-16 h-16 text-red-600" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M16.5 18.75h-9a9.75 9.75 0 01-4.973-1.803 1.875 1.875 0 01-1.227-2.738M19.197 14.21a1.875 1.875 0 01-1.227 2.738 9.75 9.75 0 01-4.973 1.803h-9M15 21h-6a.75.75 0 01-.75-.75v-2.25a.75.75 0 01.75-.75h6a.75.75 0 01.75.75V20.25a.75.75 0 01-.75.75zM12 2.25c-3.131 0-5.666 2.343-6.425 5.354.744-.56 1.684-.879 2.675-.879h7.5c.991 0 1.931.32 2.675.879C17.666 4.593 15.131 2.25 12 2.25zM12 9a.75.75 0 01-.75-.75V3a.75.75 0 011.5 0v5.25A.75.75 0 0112 9zM3.75 9.75a3 3 0 013-3h10.5a3 3 0 013 3v3.375a3 3 0 01-3 3H6.75a3 3 0 01-3-3V9.75z" />
                    </svg>
                </div>
                <h1 class="text-4xl md:text-5xl font-bold text-gray-900 tracking-tight">Campeonato de Futebol Digital</h1>
                <p id="tournament-mode-indicator" class="text-gray-600 mt-2 text-lg">Acompanhe a fase de grupos e as eliminatórias!</p>
                <div id="admin-mode-indicator" class="hidden absolute top-0 right-0 bg-red-600 text-white text-xs font-bold px-3 py-1 rounded-bl-lg">MODO ADMIN</div>
            </header>

            <main>
                <section id="setup-stage" class="mb-12 bg-white p-6 rounded-xl shadow-lg border border-gray-200">
                    <h2 class="text-3xl font-bold text-gray-900 border-b-2 border-red-500 pb-2 mb-6">Configurar Torneio</h2>
                    
                    <div class="bg-blue-50 border-l-4 border-blue-400 p-4 text-blue-800 rounded-r-lg mb-6">
                        <p class="font-bold">Como funciona a eliminatória?</p>
                        <p class="text-sm">O sistema gera o mata-mata automaticamente baseado no número de grupos:</p>
                        <ul class="list-disc list-inside mt-1 text-sm">
                            <li><strong>Crie 2 Grupos:</strong> O torneio começará diretamente nas <strong>Semifinais</strong>.</li>
                            <li><strong>Crie 4 Grupos:</strong> O torneio começará nas <strong>Quartas de Final</strong>.</li>
                        </ul>
                    </div>

                    <div id="notification-area" class="mb-4"></div>
                    <div class="space-y-4 md:flex md:space-y-0 md:space-x-4">
                        <div class="flex-1">
                            <label for="group-name-input" class="block mb-2 text-sm font-medium text-gray-700">Nome do Grupo (Ex: A, B, C  )</label>
                            <input type="text" id="group-name-input" class="bg-gray-100 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-red-500 focus:border-red-500 block w-full p-2.5" placeholder="Grupo A">
                        </div>
                        <div class="flex-[3]">
                            <label for="team-names-input" class="block mb-2 text-sm font-medium text-gray-700">Nomes dos Times (separados por vírgula)</label>
                            <input type="text" id="team-names-input" class="bg-gray-100 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-red-500 focus:border-red-500 block w-full p-2.5" placeholder="Time 1, Time 2, Time 3, Time 4">
                        </div>
                        <div class="flex-shrink-0 self-end">
                            <div class="flex items-center space-x-2">
                                <button id="add-group-btn" class="w-full bg-red-600 hover:bg-red-700 text-white font-bold py-2.5 px-6 rounded-lg shadow-lg transition-transform transform hover:scale-105">
                                    Adicionar
                                </button>
                                <button id="reset-tournament-btn" class="bg-gray-600 hover:bg-gray-700 text-white font-bold py-2.5 px-6 rounded-lg shadow-lg transition-transform transform hover:scale-105">
                                    Resetar Tudo
                                </button>
                            </div>
                        </div>
                    </div>
                </section>
                <section id="group-stage" class="mb-12" style="display: none;">
                    <h2 class="text-3xl font-bold text-gray-900 border-b-2 border-red-500 pb-2 mb-6">Fase de Grupos</h2>
                    <div id="groups-container" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-2 gap-6"></div>
                    <div id="advance-btn-container" class="mt-8 text-center" style="display: none;">
                        <button id="advance-teams-btn" class="bg-red-600 hover:bg-red-700 text-white font-bold py-3 px-6 rounded-lg shadow-lg transition-transform transform hover:scale-105">
                            Gerar Eliminatórias
                        </button>
                    </div>
                </section>
                <section id="knockout-stage" style="display: none;">
                    <h2 class="text-3xl font-bold text-gray-900 border-b-2 border-red-500 pb-2 mb-8">Fase Eliminatória</h2>
                    <div id="knockout-container" class="flex flex-col md:flex-row justify-center items-stretch md:space-x-16 space-y-8 md:space-y-0 overflow-x-auto pb-8"></div>
                </section>
                 <section id="champion-section" class="text-center my-12" style="display: none;">
                    <div class="relative bg-white p-8 rounded-xl shadow-2xl border-4 border-amber-400 overflow-hidden">
                        <canvas id="confetti-canvas" class="absolute top-0 left-0 w-full h-full pointer-events-none"></canvas>
                        <div class="relative z-10">
                             <div class="flex justify-center items-center mb-4">
                                <svg class="w-16 h-16 text-amber-400 drop-shadow-lg" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                                  <path stroke-linecap="round" stroke-linejoin="round" d="M16.5 18.75h-9a9.75 9.75 0 01-4.973-1.803 1.875 1.875 0 01-1.227-2.738M19.197 14.21a1.875 1.875 0 01-1.227 2.738 9.75 9.75 0 01-4.973 1.803h-9M15 21h-6a.75.75 0 01-.75-.75v-2.25a.75.75 0 01.75-.75h6a.75.75 0 01.75.75V20.25a.75.75 0 01-.75.75zM12 2.25c-3.131 0-5.666 2.343-6.425 5.354.744-.56 1.684-.879 2.675-.879h7.5c.991 0 1.931.32 2.675.879C17.666 4.593 15.131 2.25 12 2.25zM12 9a.75.75 0 01-.75-.75V3a.75.75 0 011.5 0v5.25A.75.75 0 0112 9zM3.75 9.75a3 3 0 013-3h10.5a3 3 0 013 3v3.375a3 3 0 01-3 3H6.75a3 3 0 01-3-3V9.75z" />
                                 </svg>
                            </div>
                            <h2 class="text-2xl font-bold text-gray-600 uppercase tracking-widest">O Grande Campeão</h2>
                            <p id="champion-name" class="text-5xl md:text-7xl font-bold text-transparent bg-clip-text bg-gradient-to-r from-red-600 to-amber-500 my-4"></p>
                        </div>
                    </div>
                </section>
            </main>
            <footer class="text-center mt-12 py-4 border-t border-gray-200">
                <p class="text-gray-500">&copy; 2025 - Plataforma de Torneio. Criado para a comunidade por Jerry Gleydison.</p>
            </footer>
        </div>
    </div>

    <!-- Modals -->
    <div id="confirmation-modal" class="fixed inset-0 bg-gray-900 bg-opacity-50 flex items-center justify-center z-50" style="display: none;">
        <div class="bg-white rounded-lg shadow-xl p-6 w-full max-w-sm">
            <p id="confirmation-message" class="text-lg text-gray-800 mb-6">Você tem certeza?</p>
            <div class="flex justify-end space-x-4">
                <button id="confirm-cancel-btn" class="px-4 py-2 bg-gray-300 hover:bg-gray-400 text-gray-800 rounded-lg">Cancelar</button>
                <button id="confirm-action-btn" class="px-4 py-2 bg-red-600 hover:bg-red-700 text-white rounded-lg">Confirmar</button>
            </div>
        </div>
    </div>
    
    <div id="logo-upload-modal" class="fixed inset-0 bg-gray-900 bg-opacity-50 flex items-center justify-center z-50" style="display: none;">
        <div class="bg-white rounded-lg shadow-xl p-6 w-full max-w-sm text-center">
            <h3 class="text-lg font-bold mb-4">Escolher Escudo do Time</h3>
            <div class="mb-4">
                <img id="logo-preview" src="" alt="Pré-visualização do escudo" class="w-24 h-24 mx-auto rounded-full object-cover border mb-4 bg-gray-100">
                <input type="file" id="logo-file-input" class="block w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-red-50 file:text-red-700 hover:file:bg-red-100 cursor-pointer" accept="image/*">
            </div>
            <div class="flex justify-end space-x-4">
                <button id="cancel-logo-upload-btn" class="px-4 py-2 bg-gray-300 hover:bg-gray-400 text-gray-800 rounded-lg">Cancelar</button>
                <button id="confirm-logo-upload-btn" class="px-4 py-2 bg-red-600 hover:bg-red-700 text-white rounded-lg">Salvar</button>
            </div>
        </div>
    </div>

    <script type="module">
        // --- Importações do Firebase ---
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
        import { getFirestore, doc, onSnapshot, setDoc, deleteDoc } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

        // --- Variáveis Globais ---
        let tournamentData = { groups: {}, matches: {}, knockout: {} };
        let isKnockoutGenerated = false;
        let confirmCallback = null;
        let confettiAnimationId;
        const loadingOverlay = document.getElementById('loading-overlay' );
        let saveDataDebounceTimer;
        let isAdmin = false; // NOVA VARIÁVEL: Controla o modo admin

        // --- Variáveis do Firebase ---
        let db, auth, tournamentDocRef;
        let unsubscribeFirestore = () => {};

        // --- INICIALIZAÇÃO ---
        document.addEventListener('DOMContentLoaded', () => {
            // NOVA LÓGICA: Verifica se a URL contém o parâmetro de admin
            const urlParams = new URLSearchParams(window.location.search);
            isAdmin = urlParams.get('admin') === 'true';
            
            initializeFirebase();
            setupEventListeners();
            
            // NOVA LÓGICA: Aplica o modo de apenas leitura se não for admin
            if (!isAdmin) {
                document.body.classList.add('read-only-mode');
                document.getElementById('tournament-mode-indicator').textContent = "Acompanhe os resultados em tempo real!";
            } else {
                document.getElementById('admin-mode-indicator').classList.remove('hidden');
            }
        });

        async function initializeFirebase() {
            try {
                // SUA CONFIGURAÇÃO DO FIREBASE
                const firebaseConfig = {
                    apiKey: "AIzaSyADVsS_wCzlQv-mVRLf_tZOq7suWavbYTw",
                    authDomain: "copa-play-ps4.firebaseapp.com",
                    projectId: "copa-play-ps4",
                    storageBucket: "copa-play-ps4.appspot.com", // Corrigido para .appspot.com
                    messagingSenderId: "204861096387",
                    appId: "1:204861096387:web:69fdef9e45f54eae487d76"
                };
                
                const app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
                
                // O documento agora é fixo, representando um único torneio por vez
                tournamentDocRef = doc(db, "tournaments", "current");

                onAuthStateChanged(auth, async (user) => {
                    if (user) {
                        console.log("Usuário autenticado:", user.uid);
                        setupFirestoreListener();
                    } else {
                        console.log("Nenhum usuário. Tentando autenticar anonimamente...");
                        try {
                            await signInAnonymously(auth);
                        } catch (error) {
                            console.error("Erro na autenticação anônima:", error);
                            loadingOverlay.innerHTML = '<p class="text-red-600">Falha na autenticação. Recarregue a página.</p>';
                        }
                    }
                });

            } catch (error) {
                console.error("Erro ao inicializar o Firebase:", error);
                loadingOverlay.innerHTML = '<p class="text-red-600">Erro crítico ao conectar com a base de dados.</p>';
            }
        }

        function setupFirestoreListener() {
            unsubscribeFirestore();
            unsubscribeFirestore = onSnapshot(tournamentDocRef, (docSnap) => {
                if (docSnap.exists()) {
                    const data = docSnap.data();
                    tournamentData = {
                        groups: data.groups || {},
                        matches: data.matches || {},
                        knockout: data.knockout || {},
                    };
                    console.log("Dados do Firestore carregados.");
                } else {
                    console.log("Nenhum torneio ativo encontrado. Iniciando com dados vazios.");
                    tournamentData = { groups: {}, matches: {}, knockout: {} };
                }
                
                try {
                    renderAll();
                } catch (renderError) {
                    console.error("Erro fatal durante a renderização:", renderError);
                    document.body.innerHTML = `<div class="text-center p-8 text-red-600">Ocorreu um erro grave ao exibir o torneio. Por favor, tente <button onclick="resetTournament()" class="underline font-bold">resetar os dados</button>. Erro: ${renderError.message}</div>`;
                } finally {
                     loadingOverlay.style.display = 'none';
                }
            }, (error) => {
                console.error("Erro ao ouvir dados do Firestore: ", error);
                loadingOverlay.innerHTML = `<p class="text-red-600">Erro de conexão com a base de dados: ${error.message}</p>`;
            });
        }

        function setupEventListeners() {
            document.getElementById('add-group-btn').addEventListener('click', addGroup);
            document.getElementById('advance-teams-btn').addEventListener('click', advanceTeamsToKnockout);
            document.getElementById('reset-tournament-btn').addEventListener('click', () => {
                 showConfirmationModal("Tem certeza que deseja resetar todo o torneio? Todos os dados online serão perdidos.", resetTournament);
            });
            document.getElementById('groups-container').addEventListener('input', handleGroupCardInput);
            document.getElementById('groups-container').addEventListener('click', handleGroupCardClick);
            document.getElementById('knockout-container').addEventListener('input', handleKnockoutInput);
            document.getElementById('confirm-cancel-btn').addEventListener('click', closeConfirmationModal);
            document.getElementById('confirm-action-btn').addEventListener('click', () => { if (confirmCallback) confirmCallback(); closeConfirmationModal(); });
            document.getElementById('logo-file-input').addEventListener('change', previewLogo);
            document.getElementById('cancel-logo-upload-btn').addEventListener('click', closeLogoUploadModal);
            document.getElementById('confirm-logo-upload-btn').addEventListener('click', saveLogo);
        }
        
        function resetUIState() {
            tournamentData = { groups: {}, matches: {}, knockout: {} };
            isKnockoutGenerated = false;
            renderAll();
        }

        // --- LÓGICA DE DADOS (FIRESTORE) ---
        function saveData() {
            // NOVA VERIFICAÇÃO: Só salva se for admin
            if (!isAdmin) {
                console.warn("Modo somente leitura. Alterações não serão salvas.");
                return;
            }
            clearTimeout(saveDataDebounceTimer);
            saveDataDebounceTimer = setTimeout(async () => {
                if (!tournamentDocRef) {
                    console.warn("Referência do Firestore não está pronta. Salvamento cancelado.");
                    return;
                }
                try {
                    await setDoc(tournamentDocRef, tournamentData, { merge: true });
                    console.log("Dados salvos no Firestore.");
                } catch (error) {
                    console.error("Erro ao salvar dados no Firestore:", error);
                    showNotification("Não foi possível salvar os dados. Verifique sua conexão.", "error");
                }
            }, 500);
        }

        async function resetTournament() {
            // NOVA VERIFICAÇÃO: Só reseta se for admin
            if (!isAdmin) return;
            
            loadingOverlay.style.display = 'flex';
            if (tournamentDocRef) {
                // Em vez de deletar o documento, apenas limpamos seu conteúdo
                await setDoc(tournamentDocRef, { groups: {}, matches: {}, knockout: {} });
            }
            resetUIState();
            showNotification("O torneio foi resetado.", "success");
            loadingOverlay.style.display = 'none';
        }
        
        // --- RENDERIZAÇÃO E LÓGICA DO TORNEIO (O restante do código permanece o mesmo) ---
        // ... (o restante do script JavaScript que você já tinha, sem alterações) ...
        // Cole o restante do script original a partir daqui.
        // A lógica de renderização, manipulação de eventos, etc., não precisa mudar.
        // Apenas as funções que modificam dados (saveData, resetTournament) foram protegidas.
        
        function renderAll() {
            isKnockoutGenerated = tournamentData.knockout && (tournamentData.knockout.quarterFinals?.length > 0 || tournamentData.knockout.semiFinals?.length > 0);
            if (tournamentData.groups && Object.keys(tournamentData.groups).length > 0) {
                document.getElementById('group-stage').style.display = 'block';
                if (isAdmin) { // Só mostra o botão de avançar para o admin
                    document.getElementById('advance-btn-container').style.display = 'block';
                }
            } else {
                 document.getElementById('group-stage').style.display = 'none';
                 document.getElementById('advance-btn-container').style.display = 'none';
            }
            if(isKnockoutGenerated) {
                document.getElementById('knockout-stage').style.display = 'block';
                renderKnockout();
            } else {
                document.getElementById('knockout-stage').style.display = 'none';
                document.getElementById('champion-section').style.display = 'none';
            }
            renderGroups();
        }

        function showConfirmationModal(message, callback) {
            if (!isAdmin) return;
            document.getElementById('confirmation-message').textContent = message;
            confirmCallback = callback;
            document.getElementById('confirmation-modal').style.display = 'flex';
        }

        function closeConfirmationModal() {
            document.getElementById('confirmation-modal').style.display = 'none';
            confirmCallback = null;
        }

        function showNotification(message, type = 'error', areaId = 'notification-area') {
            const notificationArea = document.getElementById(areaId);
            if (!notificationArea) return;
            const bgColor = type === 'error' ? 'bg-red-500' : 'bg-green-500';
            const notification = `<div class="${bgColor} text-white text-sm font-bold px-4 py-3 rounded-lg relative" role="alert"><span class="block sm:inline">${message}</span></div>`;
            notificationArea.innerHTML = notification;
            setTimeout(() => { notificationArea.innerHTML = ''; }, 5000);
        }

        function addGroup() {
            if (!isAdmin) return;
            const groupNameInput = document.getElementById('group-name-input');
            const teamNamesInput = document.getElementById('team-names-input');
            const groupKey = groupNameInput.value.trim().toUpperCase().replace("GRUPO ", "");
            const teams = teamNamesInput.value.split(',').map(t => ({ name: t.trim(), logo: null })).filter(t => t.name);

            if (!groupKey) return showNotification("O nome do grupo é obrigatório.", "error");
            if (teams.length < 2) return showNotification("É necessário pelo menos 2 times.", "error");
            if (tournamentData.groups && tournamentData.groups[groupKey]) return showNotification(`O Grupo ${groupKey} já existe.`, "error");

            document.getElementById('group-stage').style.display = 'block';
            document.getElementById('advance-btn-container').style.display = 'block';
            if(!tournamentData.groups) tournamentData.groups = {};
            
            // O restante da função addGroup e todas as outras funções de manipulação de dados
            // e renderização devem ser coladas aqui do script original.
            // O importante é que a função `saveData()` já tem a trava de `isAdmin`.
        }
        
        // (COLE O RESTANTE DO SCRIPT ORIGINAL AQUI)

    </script>
</body>
</html>
