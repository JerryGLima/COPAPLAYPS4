<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Campeonato de Futebol Digital</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6; /* bg-gray-100 */
        }
        .matchup { position: relative; }
        .round .matchup:not(:last-child) { margin-bottom: 3rem; }
        .connector { position: absolute; width: 2rem; border-style: solid; border-color: #d1d5db; }
        .connector.top { height: 50%; top: 0; left: -2rem; border-width: 0 0 2px 2px; border-bottom-left-radius: 0.5rem; }
        .connector.bottom { height: 50%; bottom: 0; left: -2rem; border-width: 2px 0 0 2px; border-top-left-radius: 0.5rem; }
        .connector.line { width: 2rem; height: 2px; top: 50%; left: -2rem; background-color: #d1d5db; }
        .round-connector { position: absolute; left: -4rem; width: 2rem; height: calc(100% + 3rem); top: 50%; transform: translateY(-50%); border-style: solid; border-color: #d1d5db; border-width: 0 2px 0 0; }
        .winner { font-weight: 700; color: #b91c1c; }
    </style>
</head>
<body class="text-gray-800">

    <div id="loading-overlay" class="fixed inset-0 bg-white bg-opacity-75 flex items-center justify-center z-50">
        <p class="text-xl font-semibold text-gray-700">Carregando...</p>
    </div>

    <div class="container mx-auto p-4 md:p-8">
        <!-- Se√ß√£o de Autentica√ß√£o -->
        <div id="auth-container" style="display: none;">
             <div class="max-w-md mx-auto bg-white p-8 rounded-xl shadow-lg text-center">
                <img src="imagem\logo.png" alt="Logo do Torneio" class="mx-auto mb-4 h-24 w-24 rounded-full">
                <h1 class="text-2xl font-bold text-gray-900">Bem-vindo √† Copa Digital</h1>
                <p class="text-gray-600 mt-2 mb-6">Fa√ßa login ou cadastre-se com seu e-mail para gerenciar seu torneio.</p>
                <div id="auth-notification-area" class="mb-4"></div>
                <div class="space-y-4">
                    <input type="email" id="email-input" class="bg-gray-100 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-red-500 focus:border-red-500 block w-full p-2.5" placeholder="seuemail@exemplo.com">
                    <button id="send-login-link-btn" class="w-full bg-red-600 hover:bg-red-700 text-white font-bold py-2.5 px-6 rounded-lg shadow-md transition-transform transform hover:scale-105">
                        Enviar Link M√°gico
                    </button>
                </div>
            </div>
        </div>
        
        <!-- Conte√∫do Principal do App (inicialmente oculto) -->
        <div id="app-container" style="display: none;">
            <header class="text-center mb-10 relative">
                 <div id="user-info" class="absolute top-0 right-0 text-right text-sm"></div>

                <img src="imagem\logo.png" alt="Logo do Torneio" class="mx-auto mb-4 h-24 w-24 rounded-full">
                <h1 class="text-4xl md:text-5xl font-bold text-gray-900 tracking-tight">Copa Digital de E-Futebol</h1>
                <p id="tournament-mode-indicator" class="text-gray-600 mt-2 text-lg">Acompanhe a fase de grupos e as eliminat√≥rias!</p>
            </header>

            <main>
                <!-- Bot√£o de Compartilhar -->
                <section id="share-section" class="mb-8 text-center" style="display: none;">
                    <button id="share-tournament-btn" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-8 rounded-lg shadow-lg transition-transform transform hover:scale-105">
                        Compartilhar Torneio
                    </button>
                </section>
                
                <section id="setup-stage" class="mb-12 bg-white p-6 rounded-xl shadow-lg border border-gray-200">
                    <h2 class="text-3xl font-bold text-gray-900 border-b-2 border-red-500 pb-2 mb-6">Configurar Torneio</h2>
                    <div id="notification-area" class="mb-4"></div>
                    <div class="space-y-4 md:flex md:space-y-0 md:space-x-4">
                        <div class="flex-1">
                            <label for="group-name-input" class="block mb-2 text-sm font-medium text-gray-700">Nome do Grupo (Ex: A, B, C)</label>
                            <input type="text" id="group-name-input" class="bg-gray-100 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-red-500 focus:border-red-500 block w-full p-2.5" placeholder="Grupo A">
                        </div>
                        <div class="flex-[3]">
                            <label for="team-names-input" class="block mb-2 text-sm font-medium text-gray-700">Nomes dos Times (separados por v√≠rgula)</label>
                            <input type="text" id="team-names-input" class="bg-gray-100 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-red-500 focus:border-red-500 block w-full p-2.5" placeholder="Time 1, Time 2, Time 3, Time 4">
                        </div>
                        <div class="flex-shrink-0 self-end">
                            <div class="flex items-center space-x-2">
                                <button id="add-group-btn" class="w-full bg-red-600 hover:bg-red-700 text-white font-bold py-2.5 px-6 rounded-lg shadow-lg transition-transform transform hover:scale-105">
                                    Adicionar
                                </button>
                                <button id="reset-tournament-btn" class="bg-gray-600 hover:bg-gray-700 text-white font-bold py-2.5 px-6 rounded-lg shadow-lg transition-transform transform hover:scale-105">
                                    Resetar Tudo
                                </button>
                            </div>
                        </div>
                    </div>
                </section>
                <section id="group-stage" class="mb-12" style="display: none;">
                    <h2 class="text-3xl font-bold text-gray-900 border-b-2 border-red-500 pb-2 mb-6">Fase de Grupos</h2>
                    <div id="groups-container" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-2 gap-6"></div>
                    <div id="advance-btn-container" class="mt-8 text-center" style="display: none;">
                        <button id="advance-teams-btn" class="bg-red-600 hover:bg-red-700 text-white font-bold py-3 px-6 rounded-lg shadow-lg transition-transform transform hover:scale-105">
                            Gerar Eliminat√≥rias
                        </button>
                    </div>
                </section>
                <section id="knockout-stage" style="display: none;">
                    <h2 class="text-3xl font-bold text-gray-900 border-b-2 border-red-500 pb-2 mb-8">Fase Eliminat√≥ria</h2>
                    <div id="knockout-container" class="flex flex-col md:flex-row justify-center items-stretch md:space-x-16 space-y-8 md:space-y-0 overflow-x-auto pb-8"></div>
                </section>
                <section id="champion-section" class="text-center my-12" style="display: none;">
                    <div class="bg-white p-8 rounded-xl shadow-lg border-2 border-amber-400">
                        <h2 class="text-2xl font-bold text-gray-500 uppercase tracking-widest">üèÜ O Grande Campe√£o üèÜ</h2>
                        <p id="champion-name" class="text-5xl md:text-7xl font-bold text-red-700 my-4 animate-pulse"></p>
                    </div>
                </section>
            </main>
            <footer class="text-center mt-12 py-4 border-t border-gray-200">
                <p class="text-gray-500">&copy; 2024 - Plataforma de Torneio. Criado para a comunidade.</p>
            </footer>
        </div>
    </div>

    <!-- Modals -->
    <div id="confirmation-modal" class="fixed inset-0 bg-gray-900 bg-opacity-50 flex items-center justify-center z-50" style="display: none;">
        <div class="bg-white rounded-lg shadow-xl p-6 w-full max-w-sm">
            <p id="confirmation-message" class="text-lg text-gray-800 mb-6">Voc√™ tem certeza?</p>
            <div class="flex justify-end space-x-4">
                <button id="confirm-cancel-btn" class="px-4 py-2 bg-gray-300 hover:bg-gray-400 text-gray-800 rounded-lg">Cancelar</button>
                <button id="confirm-action-btn" class="px-4 py-2 bg-red-600 hover:bg-red-700 text-white rounded-lg">Confirmar</button>
            </div>
        </div>
    </div>
     <div id="share-modal" class="fixed inset-0 bg-gray-900 bg-opacity-50 flex items-center justify-center z-50" style="display: none;">
        <div class="bg-white rounded-lg shadow-xl p-6 w-full max-w-lg text-center">
            <h3 class="text-2xl font-bold mb-4">Link para Visualiza√ß√£o</h3>
            <p class="text-gray-600 mb-4">Envie este link para os participantes. Eles poder√£o ver o torneio, mas n√£o poder√£o editar.</p>
            <input type="text" id="share-link-input" class="w-full bg-gray-100 border border-gray-300 p-2 rounded-lg text-center" readonly>
            <div class="mt-6 flex justify-center space-x-4">
                 <button id="copy-link-btn" class="px-6 py-2 bg-green-600 hover:bg-green-700 text-white rounded-lg">Copiar Link</button>
                <button id="close-share-modal-btn" class="px-6 py-2 bg-gray-300 hover:bg-gray-400 text-gray-800 rounded-lg">Fechar</button>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, onAuthStateChanged, sendSignInLinkToEmail, isSignInWithEmailLink, signInWithEmailLink, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, setDoc, deleteDoc, setLogLevel, collection, addDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- CONFIGURA√á√ÉO DO FIREBASE ---
        const firebaseConfig = {
            apiKey: "AIzaSyADVsS_wCzlQv-mVRLf_tZOq7suWavbYTw",
            authDomain: "copa-play-ps4.firebaseapp.com",
            projectId: "copa-play-ps4",
            storageBucket: "copa-play-ps4.appspot.com",
            messagingSenderId: "204861096387",
            appId: "1:204861096387:web:69fdef9e45f54eae487d76"
        };

        // Inicializa o Firebase
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const appId = firebaseConfig.appId;
        setLogLevel('debug');

        // --- Vari√°veis Globais ---
        let tournamentData = { groups: {}, matches: {}, knockout: {} };
        let isKnockoutGenerated = false;
        let confirmCallback = null;
        let userId;
        let isReadOnly = false;
        const loadingOverlay = document.getElementById('loading-overlay');

        // --- INICIALIZA√á√ÉO E AUTENTICA√á√ÉO ---
        document.addEventListener('DOMContentLoaded', () => {
            const urlParams = new URLSearchParams(window.location.search);
            const viewTournamentId = urlParams.get('view');
            
            if (viewTournamentId) {
                isReadOnly = true;
                loadPublicData(viewTournamentId);
            } else {
                handleLoginRedirect();
                onAuthStateChanged(auth, user => {
                    const authContainer = document.getElementById('auth-container');
                    const appContainer = document.getElementById('app-container');
                    if (user) {
                        userId = user.uid;
                        authContainer.style.display = 'none';
                        appContainer.style.display = 'block';
                        document.getElementById('share-section').style.display = 'block';
                        updateUserInfo(user);
                        loadPrivateData();
                    } else {
                        userId = null;
                        authContainer.style.display = 'block';
                        appContainer.style.display = 'none';
                        resetUIState();
                        loadingOverlay.style.display = 'none';
                    }
                });
            }
            setupEventListeners();
        });

        function setupEventListeners() {
            document.getElementById('send-login-link-btn').addEventListener('click', sendLoginLink);
            document.getElementById('add-group-btn').addEventListener('click', addGroup);
            document.getElementById('advance-teams-btn').addEventListener('click', advanceTeamsToKnockout);
            document.getElementById('reset-tournament-btn').addEventListener('click', resetTournament);
            document.getElementById('groups-container').addEventListener('click', handleGroupCardClick);
            document.getElementById('confirm-cancel-btn').addEventListener('click', closeConfirmationModal);
            document.getElementById('confirm-action-btn').addEventListener('click', () => { if (confirmCallback) confirmCallback(); closeConfirmationModal(); });
            document.getElementById('share-tournament-btn').addEventListener('click', shareTournament);
            document.getElementById('close-share-modal-btn').addEventListener('click', () => document.getElementById('share-modal').style.display = 'none');
            document.getElementById('copy-link-btn').addEventListener('click', copyShareLink);
        }
        
        async function handleLoginRedirect() {
             if (isSignInWithEmailLink(auth, window.location.href)) {
                let email = window.localStorage.getItem('emailForSignIn');
                if (!email) email = window.prompt('Por favor, forne√ßa seu e-mail para confirma√ß√£o');
                try {
                    await signInWithEmailLink(auth, email, window.location.href);
                    window.localStorage.removeItem('emailForSignIn');
                    window.history.replaceState({}, document.title, window.location.pathname);
                } catch (error) { showNotification("N√£o foi poss√≠vel fazer login. O link pode ser inv√°lido ou ter expirado.", 'error', 'auth-notification-area'); }
            }
        }
        
        async function sendLoginLink() {
            const email = document.getElementById('email-input').value.trim();
            if (!email) return showNotification('Por favor, insira um e-mail v√°lido.', 'error', 'auth-notification-area');
            const actionCodeSettings = { url: window.location.href, handleCodeInApp: true };
            try {
                await sendSignInLinkToEmail(auth, email, actionCodeSettings);
                window.localStorage.setItem('emailForSignIn', email);
                showNotification(`Link de login enviado para ${email}. Verifique sua caixa de entrada!`, 'success', 'auth-notification-area');
            } catch (error) { showNotification('Ocorreu um erro ao enviar o link. Tente novamente.', 'error', 'auth-notification-area'); }
        }

        function updateUserInfo(user) {
            const userInfoDiv = document.getElementById('user-info');
            userInfoDiv.innerHTML = `<p class="font-semibold">${user.email}</p><button id="logout-btn" class="text-red-600 hover:underline">Sair</button>`;
            document.getElementById('logout-btn').addEventListener('click', () => signOut(auth));
        }
        
        function resetUIState() {
            tournamentData = { groups: {}, matches: {}, knockout: {} };
            isKnockoutGenerated = false;
            renderAll();
        }

        // --- L√ìGICA DE DADOS (FIRESTORE) ---
        async function savePrivateData() {
            if (!userId) return;
            const docRef = doc(db, 'artifacts', appId, 'users', userId, 'data', 'mainTournament');
            try {
                await setDoc(docRef, { ...tournamentData, ownerId: userId });
            } catch (error) { console.error("Erro ao salvar dados:", error); showNotification("N√£o foi poss√≠vel salvar os dados.", "error"); }
        }

        async function loadPrivateData() {
            loadingOverlay.style.display = 'flex';
            if (!userId) return;
            const docRef = doc(db, 'artifacts', appId, 'users', userId, 'data', 'mainTournament');
            const docSnap = await getDoc(docRef);
            if (docSnap.exists()) {
                tournamentData = docSnap.data();
            } else {
                tournamentData = { groups: {}, matches: {}, knockout: {}, ownerId: userId };
            }
            renderAll();
            loadingOverlay.style.display = 'none';
        }

        async function loadPublicData(tournamentId) {
            loadingOverlay.style.display = 'flex';
            const docRef = doc(db, 'artifacts', appId, 'public/data/tournaments', tournamentId);
            try {
                const docSnap = await getDoc(docRef);
                if (docSnap.exists()) {
                    tournamentData = docSnap.data();
                    document.getElementById('auth-container').style.display = 'none';
                    document.getElementById('app-container').style.display = 'block';
                    renderAll();
                } else {
                    document.body.innerHTML = `<div class="text-center p-8 text-red-600">Torneio n√£o encontrado. O link pode estar incorreto.</div>`;
                }
            } catch (error) {
                 document.body.innerHTML = `<div class="text-center p-8 text-red-600">Erro ao carregar o torneio.</div>`;
            } finally {
                loadingOverlay.style.display = 'none';
            }
        }

        async function resetTournament() {
            showConfirmationModal("Tem certeza que deseja resetar todo o torneio? Esta a√ß√£o n√£o pode ser desfeita.", async () => {
                if (userId) {
                    const docRef = doc(db, 'artifacts', appId, 'users', userId, 'data', 'mainTournament');
                    try { await deleteDoc(docRef); } catch (error) { console.error("Erro ao deletar dados:", error); }
                }
                resetUIState();
                showNotification("Torneio resetado com sucesso!", "success");
            });
        }
        
        async function shareTournament() {
            const publicId = tournamentData.publicId || doc(collection(db, '_')).id;
            const publicDocRef = doc(db, 'artifacts', appId, 'public/data/tournaments', publicId);
            
            try {
                await setDoc(publicDocRef, { ...tournamentData, lastUpdated: serverTimestamp() });
                if (!tournamentData.publicId) {
                    tournamentData.publicId = publicId;
                    await savePrivateData();
                }
                const shareLink = `${window.location.origin}${window.location.pathname}?view=${publicId}`;
                const linkInput = document.getElementById('share-link-input');
                linkInput.value = shareLink;
                document.getElementById('share-modal').style.display = 'flex';
                document.getElementById('share-tournament-btn').textContent = "Atualizar Link P√∫blico";
            } catch (error) {
                console.error("Erro ao compartilhar:", error);
                showNotification("N√£o foi poss√≠vel compartilhar o torneio.", "error");
            }
        }
        
        function copyShareLink() {
            const linkInput = document.getElementById('share-link-input');
            linkInput.select();
            linkInput.setSelectionRange(0, 99999);
            navigator.clipboard.writeText(linkInput.value);
            showNotification("Link copiado para a √°rea de transfer√™ncia!", "success");
        }

        function renderAll() {
            renderGroups();
            renderKnockout();
            enterReadOnlyMode();
        }

        function enterReadOnlyMode() {
            if (!isReadOnly) return;
            document.getElementById('tournament-mode-indicator').textContent = "Visualiza√ß√£o P√∫blica - Somente Leitura";
            document.getElementById('setup-stage').style.display = 'none';
            document.getElementById('share-section').style.display = 'none';
            document.querySelectorAll('button:not(#close-share-modal-btn):not(#copy-link-btn)').forEach(btn => btn.style.display = 'none');
            document.querySelectorAll('input').forEach(input => input.disabled = true);
        }

        function showNotification(message, type = 'info', containerId = 'notification-area') {
            const container = document.getElementById(containerId);
            const bgColor = type === 'error' ? 'bg-red-100 border-red-400 text-red-700' : type === 'success' ? 'bg-green-100 border-green-400 text-green-700' : 'bg-blue-100 border-blue-400 text-blue-700';
            container.innerHTML = `<div class="border px-4 py-3 rounded ${bgColor}" role="alert"><span class="block sm:inline">${message}</span></div>`;
            setTimeout(() => container.innerHTML = '', 5000);
        }

        function showConfirmationModal(message, callback) {
            document.getElementById('confirmation-message').textContent = message;
            document.getElementById('confirmation-modal').style.display = 'flex';
            confirmCallback = callback;
        }

        function closeConfirmationModal() {
            document.getElementById('confirmation-modal').style.display = 'none';
            confirmCallback = null;
        }

        // --- L√ìGICA DOS GRUPOS ---
        function addGroup() {
            const groupName = document.getElementById('group-name-input').value.trim().toUpperCase();
            const teamNamesInput = document.getElementById('team-names-input').value.trim();
            
            if (!groupName) return showNotification("Por favor, insira o nome do grupo.");
            if (!teamNamesInput) return showNotification("Por favor, insira os nomes dos times.");
            
            const groupKey = groupName.replace("GRUPO ", "");
            if (tournamentData.groups[groupKey]) return showNotification("Este grupo j√° existe.");
            
            const teamNames = teamNamesInput.split(',').map(name => name.trim()).filter(name => name);
            if (teamNames.length < 2) return showNotification("√â necess√°rio pelo menos 2 times por grupo.");
            
            tournamentData.groups[groupKey] = { name: `Grupo ${groupKey}`, teams: teamNames };
            generateGroupMatches(groupKey);
            
            document.getElementById('group-name-input').value = '';
            document.getElementById('team-names-input').value = '';
            
            savePrivateData();
            renderGroups();
            showNotification(`${tournamentData.groups[groupKey].name} adicionado com sucesso!`, "success");
        }

        function generateGroupMatches(groupKey) {
            const teams = tournamentData.groups[groupKey].teams;
            const matches = [];
            for (let i = 0; i < teams.length; i++) {
                for (let j = i + 1; j < teams.length; j++) {
                    matches.push({ teamA: teams[i], teamB: teams[j], scoreA: null, scoreB: null });
                }
            }
            tournamentData.matches[groupKey] = matches;
        }

        function calculateStandings(groupKey) {
            const teams = tournamentData.groups[groupKey].teams;
            const matches = tournamentData.matches[groupKey] || [];
            const standings = teams.map(team => ({ name: team, points: 0, goalsFor: 0, goalsAgainst: 0, goalDifference: 0, wins: 0, draws: 0, losses: 0 }));
            
            matches.forEach(match => {
                if (match.scoreA !== null && match.scoreB !== null) {
                    const teamAIndex = standings.findIndex(t => t.name === match.teamA);
                    const teamBIndex = standings.findIndex(t => t.name === match.teamB);
                    
                    standings[teamAIndex].goalsFor += match.scoreA;
                    standings[teamAIndex].goalsAgainst += match.scoreB;
                    standings[teamBIndex].goalsFor += match.scoreB;
                    standings[teamBIndex].goalsAgainst += match.scoreA;
                    
                    if (match.scoreA > match.scoreB) {
                        standings[teamAIndex].points += 3;
                        standings[teamAIndex].wins++;
                        standings[teamBIndex].losses++;
                    } else if (match.scoreA < match.scoreB) {
                        standings[teamBIndex].points += 3;
                        standings[teamBIndex].wins++;
                        standings[teamAIndex].losses++;
                    } else {
                        standings[teamAIndex].points += 1;
                        standings[teamBIndex].points += 1;
                        standings[teamAIndex].draws++;
                        standings[teamBIndex].draws++;
                    }
                }
            });
            
            standings.forEach(team => team.goalDifference = team.goalsFor - team.goalsAgainst);
            return standings.sort((a, b) => b.points - a.points || b.goalDifference - a.goalDifference || b.goalsFor - a.goalsFor);
        }

        function renderGroups() {
            const container = document.getElementById('groups-container');
            const groupKeys = Object.keys(tournamentData.groups);
            
            if (groupKeys.length === 0) {
                document.getElementById('group-stage').style.display = 'none';
                document.getElementById('advance-btn-container').style.display = 'none';
                return;
            }
            
            document.getElementById('group-stage').style.display = 'block';
            container.innerHTML = '';
            
            let allMatchesCompleted = true;
            
            for (const groupKey of groupKeys) {
                const group = tournamentData.groups[groupKey];
                const matches = tournamentData.matches[groupKey] || [];
                const standings = calculateStandings(groupKey);
                
                const groupMatches = matches.some(m => m.scoreA === null || m.scoreB === null);
                if (groupMatches) allMatchesCompleted = false;
                
                const matchesHtml = matches.map((match, index) => `
                    <div class="flex items-center justify-between py-2 border-b border-gray-100">
                        <div class="flex-1 text-sm">${match.teamA}</div>
                        <div class="flex items-center space-x-2">
                            <input type="number" min="0" class="score-input bg-gray-100 border border-gray-300 w-12 text-center rounded" data-match-index="${index}" data-team="A" value="${match.scoreA !== null ? match.scoreA : ''}" ${isReadOnly ? 'disabled' : ''}>
                            <span class="text-gray-500">x</span>
                            <input type="number" min="0" class="score-input bg-gray-100 border border-gray-300 w-12 text-center rounded" data-match-index="${index}" data-team="B" value="${match.scoreB !== null ? match.scoreB : ''}" ${isReadOnly ? 'disabled' : ''}>
                        </div>
                        <div class="flex-1 text-sm text-right">${match.teamB}</div>
                    </div>
                `).join('');
                
                const standingsHtml = standings.map((team, index) => `
                    <tr class="${index < 2 ? 'bg-green-50' : ''}">
                        <td class="px-2 py-1 text-sm font-medium">${index + 1}¬∫</td>
                        <td class="px-2 py-1 text-sm">${team.name}</td>
                        <td class="px-2 py-1 text-sm text-center">${team.points}</td>
                        <td class="px-2 py-1 text-sm text-center">${team.wins + team.draws + team.losses}</td>
                        <td class="px-2 py-1 text-sm text-center">${team.wins}</td>
                        <td class="px-2 py-1 text-sm text-center">${team.draws}</td>
                        <td class="px-2 py-1 text-sm text-center">${team.losses}</td>
                        <td class="px-2 py-1 text-sm text-center">${team.goalsFor}</td>
                        <td class="px-2 py-1 text-sm text-center">${team.goalsAgainst}</td>
                        <td class="px-2 py-1 text-sm text-center font-medium">${team.goalDifference > 0 ? '+' : ''}${team.goalDifference}</td>
                    </tr>
                `).join('');
                
                const groupCard = document.createElement('div');
                groupCard.className = 'bg-white p-6 rounded-xl shadow-lg border border-gray-200';
                groupCard.dataset.groupKey = groupKey;
                groupCard.innerHTML = `
                    <div class="flex items-center justify-between mb-4">
                        <h3 class="text-xl font-bold text-gray-900">${group.name}</h3>
                        ${!isReadOnly ? `
                        <div class="flex space-x-2">
                            <button class="edit-group-name-btn p-1 text-blue-600 hover:text-blue-800" title="Editar nome do grupo">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 pointer-events-none" viewBox="0 0 20 20" fill="currentColor"><path d="M13.586 3.586a2 2 0 112.828 2.828l-.793.793-2.828-2.828.793-.793zM11.379 5.793L3 14.172V17h2.828l8.38-8.379-2.83-2.828z" /></svg>
                            </button>
                            <button class="delete-group-btn p-1 text-red-600 hover:text-red-800" title="Excluir grupo">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 pointer-events-none" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M9 2a1 1 0 000 2h2a1 1 0 100-2H9zM4 5a2 2 0 012-2h8a2 2 0 012 2v10a2 2 0 01-2 2H6a2 2 0 01-2-2V5zm3 4a1 1 0 112 0v4a1 1 0 11-2 0V9zm4 0a1 1 0 112 0v4a1 1 0 11-2 0V9z" clip-rule="evenodd" /></svg>
                            </button>
                        </div>
                        ` : ''}
                    </div>
                    
                    <div class="mb-6">
                        <h4 class="font-semibold text-gray-700 mb-3">Times:</h4>
                        <div class="space-y-2">
                            ${group.teams.map(team => `
                                <div class="flex items-center justify-between bg-gray-50 p-2 rounded">
                                    <span class="text-sm">${team}</span>
                                    ${!isReadOnly ? `
                                    <div class="flex space-x-1">
                                        <button class="edit-team-name-btn p-1 text-blue-600 hover:text-blue-800" data-team-name="${team}" title="Editar nome do time">
                                            <svg xmlns="http://www.w3.org/2000/svg" class="h-3 w-3 pointer-events-none" viewBox="0 0 20 20" fill="currentColor"><path d="M13.586 3.586a2 2 0 112.828 2.828l-.793.793-2.828-2.828.793-.793zM11.379 5.793L3 14.172V17h2.828l8.38-8.379-2.83-2.828z" /></svg>
                                        </button>
                                        <button class="remove-team-btn p-1 text-red-600 hover:text-red-800" data-team-name="${team}" title="Remover time">
                                            <svg xmlns="http://www.w3.org/2000/svg" class="h-3 w-3 pointer-events-none" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd" /></svg>
                                        </button>
                                    </div>
                                    ` : ''}
                                </div>
                            `).join('')}
                        </div>
                        ${!isReadOnly ? `
                        <div class="mt-3 flex items-center space-x-2">
                            <input type="text" class="bg-gray-100 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-red-500 focus:border-red-500 block flex-1 p-2" placeholder="Nome do novo time">
                            <button class="add-team-btn bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4 rounded-lg text-sm">Adicionar</button>
                        </div>
                        ` : ''}
                    </div>
                    
                    <div class="mb-6">
                        <div class="flex items-center justify-between mb-3">
                            <h4 class="font-semibold text-gray-700">Jogos:</h4>
                            ${!isReadOnly ? `<button class="update-scores-btn bg-blue-600 hover:bg-blue-700 text-white font-bold py-1 px-3 rounded text-sm">Atualizar</button>` : ''}
                        </div>
                        <div class="space-y-2">
                            ${matchesHtml}
                        </div>
                    </div>
                    
                    <div>
                        <h4 class="font-semibold text-gray-700 mb-3">Classifica√ß√£o:</h4>
                        <div class="overflow-x-auto">
                            <table class="w-full text-xs">
                                <thead class="bg-gray-50">
                                    <tr>
                                        <th class="px-2 py-2 text-left">Pos</th>
                                        <th class="px-2 py-2 text-left">Time</th>
                                        <th class="px-2 py-2 text-center">Pts</th>
                                        <th class="px-2 py-2 text-center">J</th>
                                        <th class="px-2 py-2 text-center">V</th>
                                        <th class="px-2 py-2 text-center">E</th>
                                        <th class="px-2 py-2 text-center">D</th>
                                        <th class="px-2 py-2 text-center">GP</th>
                                        <th class="px-2 py-2 text-center">GC</th>
                                        <th class="px-2 py-2 text-center">SG</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${standingsHtml}
                                </tbody>
                            </table>
                        </div>
                    </div>
                `;
                container.appendChild(groupCard);
            }
            
            const advanceContainer = document.getElementById('advance-btn-container');
            if (allMatchesCompleted && groupKeys.length >= 2 && !isKnockoutGenerated && !isReadOnly) {
                advanceContainer.style.display = 'block';
            } else {
                advanceContainer.style.display = 'none';
            }
        }
        
        function updateScoresAndRender(groupKey) {
            const groupCard = document.querySelector(`.bg-white[data-group-key="${groupKey}"]`);
            if(!groupCard) return;
            const inputs = groupCard.querySelectorAll(`.score-input`);
            inputs.forEach(input => {
                const { matchIndex, team } = input.dataset;
                const value = input.value === '' ? null : parseInt(input.value);
                if (tournamentData.matches[groupKey] && tournamentData.matches[groupKey][matchIndex]) {
                    tournamentData.matches[groupKey][matchIndex][`score${team}`] = value;
                }
            });
            renderGroups();
            savePrivateData();
        }

        function advanceTeamsToKnockout() {
            for (const groupKey in tournamentData.groups) { updateScoresAndRender(groupKey); }
            const groupKeys = Object.keys(tournamentData.groups);
            if (groupKeys.length < 2) return showNotification("√â necess√°rio pelo menos 2 grupos.");
            isKnockoutGenerated = true;
            const qualifiers = {};
            groupKeys.sort().forEach(groupKey => { qualifiers[groupKey] = calculateStandings(groupKey).slice(0, 2).map(t => t.name); });
            const qfMatches = [];
            for (let i = 0; i < Math.floor(groupKeys.length / 2) * 2; i += 2) {
                const key1 = groupKeys[i], key2 = groupKeys[i + 1];
                qfMatches.push({ teamA: qualifiers[key1][0], teamB: qualifiers[key2][1], scoreA: null, scoreB: null });
                qfMatches.push({ teamA: qualifiers[key2][0], teamB: qualifiers[key1][1], scoreA: null, scoreB: null });
            }
            tournamentData.knockout = {
                quarterFinals: qfMatches,
                semiFinals: Array.from({ length: qfMatches.length / 2 }, () => ({ teamA: "Vencedor", teamB: "Vencedor", scoreA: null, scoreB: null })),
                final: Array.from({ length: Math.max(0, qfMatches.length / 4) }, () => ({ teamA: "Vencedor", teamB: "Vencedor", scoreA: null, scoreB: null }))
            };
            savePrivateData();
            renderAll();
            document.getElementById('knockout-stage').scrollIntoView({ behavior: 'smooth' });
        }
        
        function handleGroupCardClick(e) {
            if (isReadOnly) return;
            const target = e.target;
            const groupCard = target.closest('.bg-white[data-group-key]');
            if(!groupCard) return;
            const groupKey = groupCard.dataset.groupKey;
            
            const buttonMappings = {
                '.edit-group-name-btn': () => showEditInput(target.closest('button').parentElement.previousElementSibling, 'group', groupKey),
                '.delete-group-btn': () => deleteGroup(groupKey),
                '.edit-team-name-btn': () => showEditInput(target.closest('button').parentElement.previousElementSibling, 'team', groupKey, target.closest('button').dataset.teamName),
                '.remove-team-btn': () => removeTeamFromGroup(groupKey, target.closest('button').dataset.teamName),
                '.update-scores-btn': () => updateScoresAndRender(groupKey),
                '.add-team-btn': () => addTeamToGroup(groupKey, target.previousElementSibling.value)
            };

            for(const selector in buttonMappings){
                if(target.closest(selector)){
                    buttonMappings[selector]();
                    return;
                }
            }
        }

        function showEditInput(container, type, groupKey, oldName = null) {
            if (document.querySelector('.edit-input-container')) { renderGroups(); }
            const originalValue = type === 'group' ? tournamentData.groups[groupKey].name.replace('Grupo ','') : oldName;
            container.innerHTML = `<div class="edit-input-container flex items-center gap-1">
                    <input type="text" class="bg-gray-200 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-red-500 focus:border-red-500 block w-full p-1.5" value="${originalValue}">
                    <button class="save-edit-btn p-1 text-green-600 hover:text-green-800"><svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 pointer-events-none" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd" /></svg></button>
                    <button class="cancel-edit-btn p-1 text-red-600 hover:text-red-800"><svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 pointer-events-none" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd" /></svg></button>
                </div>`;
            const input = container.querySelector('input');
            input.focus(); input.select();
            
            const saveFn = () => {
                const newValue = input.value.trim();
                if (type === 'group') { updateGroupName(groupKey, newValue.toUpperCase().replace("GRUPO ", "")); } 
                else { updateTeamName(groupKey, oldName, newValue); }
            };

            container.querySelector('.save-edit-btn').onclick = saveFn;
            container.querySelector('.cancel-edit-btn').onclick = () => renderGroups();
            input.onkeydown = (e) => { if (e.key === 'Enter') saveFn(); if (e.key === 'Escape') renderGroups(); };
        }

        function addTeamToGroup(groupKey, newTeamName) {
            const teamName = newTeamName.trim();
            if(!teamName) return showNotification("O nome do time n√£o pode ser vazio.");
            if(tournamentData.groups[groupKey].teams.includes(teamName)) return showNotification("Este time j√° est√° no grupo.");
            
            tournamentData.groups[groupKey].teams.push(teamName);
            generateGroupMatches(groupKey);
            savePrivateData();
            renderGroups();
        }

        function removeTeamFromGroup(groupKey, teamName) {
            if(tournamentData.groups[groupKey].teams.length <= 2) return showNotification("O grupo precisa ter pelo menos 2 times.");
            showConfirmationModal(`Tem certeza que deseja remover "${teamName}" do grupo?`, () => {
                tournamentData.groups[groupKey].teams = tournamentData.groups[groupKey].teams.filter(t => t !== teamName);
                generateGroupMatches(groupKey);
                savePrivateData();
                renderGroups();
            });
        }
        function deleteGroup(groupKey) {
            showConfirmationModal(`Tem certeza que deseja excluir o "${tournamentData.groups[groupKey].name}"?`, () => {
                delete tournamentData.groups[groupKey];
                delete tournamentData.matches[groupKey];
                savePrivateData();
                renderGroups();
            });
        }
        function updateGroupName(oldGroupKey, newGroupKey) {
            if (!newGroupKey) { return showNotification("O nome do grupo n√£o pode ser vazio."), renderGroups(); }
            if (newGroupKey === oldGroupKey) { return renderGroups(); }
            if (tournamentData.groups[newGroupKey]) { return showNotification("Esse nome de grupo j√° existe."), renderGroups(); }
            
            tournamentData.groups[newGroupKey] = { ...tournamentData.groups[oldGroupKey], name: `Grupo ${newGroupKey}` };
            delete tournamentData.groups[oldGroupKey];
            
            tournamentData.matches[newGroupKey] = [...tournamentData.matches[oldGroupKey]];
            delete tournamentData.matches[oldGroupKey];
            
            savePrivateData(); 
            renderGroups();
        }

        function updateTeamName(groupKey, oldName, newName) {
            if (!newName) { return showNotification("O nome do time n√£o pode ser vazio."), renderGroups(); }
            if (newName === oldName) { return renderGroups(); }
            if (tournamentData.groups[groupKey].teams.includes(newName)) { return showNotification("Esse nome de time j√° existe no grupo."), renderGroups(); }
            
            const teamIndex = tournamentData.groups[groupKey].teams.indexOf(oldName);
            if (teamIndex > -1) tournamentData.groups[groupKey].teams[teamIndex] = newName;
            
            tournamentData.matches[groupKey].forEach(match => {
                if (match.teamA === oldName) match.teamA = newName;
                if (match.teamB === oldName) match.teamB = newName;
            });
            savePrivateData();
            renderGroups();
        }

        function renderKnockout() {
            const container = document.getElementById('knockout-container');
            container.innerHTML = '';
            const data = tournamentData.knockout;
            if (!data || !data.quarterFinals || data.quarterFinals.length === 0) return;

            document.getElementById('knockout-stage').style.display = 'block';

            const qfWinners = data.quarterFinals.map(m => (m.scoreA !== null && m.scoreB !== null) ? (m.scoreA > m.scoreB ? m.teamA : m.teamB) : null);
            for (let i = 0; i < data.semiFinals.length; i++) {
                data.semiFinals[i].teamA = qfWinners[i * 2] || `Vencedor J${i * 2 + 1}`;
                data.semiFinals[i].teamB = qfWinners[i * 2 + 1] || `Vencedor J${i * 2 + 2}`;
            }
            const sfWinners = data.semiFinals.map(m => (m.scoreA !== null && m.scoreB !== null) ? (m.scoreA > m.scoreB ? m.teamA : m.teamB) : null);
            for (let i = 0; i < data.final.length; i++) {
                data.final[i].teamA = sfWinners[i * 2] || `Vencedor SF${i * 2 + 1}`;
                data.final[i].teamB = sfWinners[i * 2 + 1] || `Vencedor SF${i * 2 + 2}`;
            }

            const qfHtml = data.quarterFinals.map((m, i) => createMatchupHTML(m, 'quarterFinals', i, i % 2 === 0)).join('');
            const sfHtml = data.semiFinals.map((m, i) => createMatchupHTML(m, 'semiFinals', i, true, true)).join('');
            const finalHtml = data.final.map((m, i) => createMatchupHTML(m, 'final', i, false, true)).join('');

            container.innerHTML = createRoundHTML("Quartas de Final", qfHtml) + createRoundHTML("Semifinais", sfHtml, 'justify-around') + createRoundHTML("Final", finalHtml, 'justify-center');
            if (isReadOnly) document.querySelectorAll('.knockout-score-input').forEach(i => i.disabled = true);
            else document.querySelectorAll('.knockout-score-input').forEach(input => input.addEventListener('change', updateKnockoutScore));

            const finalMatch = data.final[0];
            if (finalMatch && finalMatch.scoreA !== null && finalMatch.scoreB !== null && !finalMatch.teamA.includes('Vencedor') && !finalMatch.teamB.includes('Vencedor')) {
                const champion = finalMatch.scoreA > finalMatch.scoreB ? finalMatch.teamA : finalMatch.teamB;
                tournamentData.knockout.champion = champion;
                showChampion(champion);
            } else {
                 document.getElementById('champion-section').style.display = 'none';
                 if(tournamentData.knockout) delete tournamentData.knockout.champion;
            }
        }
        function updateKnockoutScore(e) {
            const { round, matchIndex, team } = e.target.dataset;
            const value = e.target.value === '' ? null : parseInt(e.target.value);
            tournamentData.knockout[round][matchIndex][`score${team}`] = value;
            renderKnockout();
            savePrivateData();
        }
        function showChampion(name) {
             const section = document.getElementById('champion-section');
            const nameEl = document.getElementById('champion-name');
            nameEl.textContent = name;
            section.style.display = 'block';
            section.scrollIntoView({ behavior: 'smooth' });
        }
        function createRoundHTML(title, content, justifyClass = 'justify-between') {
            if (!content) return '';
            return `<div class="round flex flex-col ${justifyClass} min-w-[280px] relative"><h3 class="text-xl font-bold text-center mb-6 h-8">${title}</h3>${content}</div>`;
        }
        function createMatchupHTML(match, roundName, index, hasConnector, isLaterRound = false) {
             const teamAClass = match.scoreA !== null && match.scoreA > match.scoreB ? 'winner' : '';
             const teamBClass = match.scoreB !== null && match.scoreB > match.scoreA ? 'winner' : '';
             let connectorHtml = '';
             if (isLaterRound) connectorHtml += `<div class="connector line"></div><div class="round-connector"></div>`;
             else if (hasConnector) connectorHtml = `<div class="connector top"></div><div class="connector bottom"></div>`;
            return `
                <div class="matchup bg-white border border-gray-200 rounded-lg p-3 relative flex-grow-0">
                    ${connectorHtml}
                    <div class="flex items-center justify-between"><span class="flex-1 text-sm ${teamAClass}">${match.teamA}</span><input type="number" min="0" class="knockout-score-input bg-gray-100 border border-gray-300 w-10 text-center rounded mx-2" data-round="${roundName}" data-match-index="${index}" data-team="A" value="${match.scoreA !== null ? match.scoreA : ''}"></div>
                    <div class="my-2 border-t border-dashed border-gray-300"></div>
                    <div class="flex items-center justify-between"><span class="flex-1 text-sm ${teamBClass}">${match.teamB}</span><input type="number" min="0" class="knockout-score-input bg-gray-100 border border-gray-300 w-10 text-center rounded mx-2" data-round="${roundName}" data-match-index="${index}" data-team="B" value="${match.scoreB !== null ? match.scoreB : ''}"></div>
                </div>`;
        }
    </script>
</body>
</html>

