<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gerenciador de Campeonato de Futebol</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6;
        }
        .matchup { position: relative; }
        .round .matchup:not(:last-child ) { margin-bottom: 3rem; }
        .winner { font-weight: 700; color: #b91c1c; }
        /* Adiciona estilos para o modo "somente leitura" */
        body.view-only .editable-control {
            pointer-events: none;
            opacity: 0.6;
            cursor: not-allowed;
        }
        body.view-only input, body.view-only button {
            cursor: not-allowed !important;
        }
    </style>
</head>
<body class="text-gray-800">

    <div id="loading-overlay" class="fixed inset-0 bg-white bg-opacity-75 flex items-center justify-center z-50">
        <p class="text-xl font-semibold text-gray-700">Carregando...</p>
    </div>

    <div class="container mx-auto p-4 md:p-8">
        
        <!-- Tela de Login -->
        <div id="login-stage">
             <div class="max-w-md mx-auto bg-white p-8 rounded-xl shadow-lg border border-gray-200 mt-16">
                <img src="imagem/logo.png" alt="Logo do Torneio" class="mx-auto mb-6 h-24 w-24 rounded-full object-cover">
                <h2 class="text-3xl font-bold text-center text-gray-900 mb-2">Acesse seu Torneio</h2>
                <p class="text-center text-gray-600 mb-6">Insira seu e-mail para receber um link de acesso mágico. Sem senhas!</p>
                <div id="login-notification-area" class="mb-4"></div>
                <div class="space-y-4">
                    <div>
                        <label for="email-input" class="block mb-2 text-sm font-medium text-gray-700">E-mail</label>
                        <input type="email" id="email-input" class="bg-gray-100 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-red-500 focus:border-red-500 block w-full p-2.5" placeholder="seu@email.com" required>
                    </div>
                    <button id="send-magic-link-btn" class="w-full bg-red-600 hover:bg-red-700 text-white font-bold py-3 px-6 rounded-lg shadow-lg transition-transform transform hover:scale-105">
                        Enviar Link Mágico
                    </button>
                </div>
            </div>
        </div>

        <!-- Conteúdo Principal do App -->
        <div id="app-container" style="display: none;">
            <header class="text-center mb-10 relative">
                 <div id="auth-status" class="absolute top-0 right-0 text-right text-sm"></div>
                <img id="main-logo-img" src="imagem/logo.png" alt="Logo do Torneio" class="mx-auto mb-4 h-24 w-24 rounded-full object-cover">
                <h1 class="text-4xl md:text-5xl font-bold text-gray-900 tracking-tight">Campeonato de Futebol Digital</h1>
                <p id="tournament-mode-indicator" class="text-gray-600 mt-2 text-lg">Acompanhe a fase de grupos e as eliminatórias!</p>
                 <div id="view-only-banner" class="mt-4 bg-yellow-100 border-l-4 border-yellow-500 text-yellow-700 p-4 rounded-r-lg" style="display: none;">
                    <p class="font-bold">Modo de Visualização</p>
                    <p>Você está vendo este torneio como espectador. Nenhuma alteração pode ser feita.</p>
                </div>
            </header>

            <main>
                <section id="setup-stage" class="editable-control mb-12 bg-white p-6 rounded-xl shadow-lg border border-gray-200">
                    <div class="flex justify-between items-start">
                        <h2 class="text-3xl font-bold text-gray-900 border-b-2 border-red-500 pb-2 mb-6">Configurar Torneio</h2>
                        <button id="share-tournament-btn" class="flex items-center space-x-2 bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg shadow-lg transition-transform transform hover:scale-105">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path d="M15 8a3 3 0 10-2.977-2.63l-4.94 2.47a3 3 0 100 4.319l4.94 2.47a3 3 0 10.895-1.789l-4.94-2.47a3.027 3.027 0 000-.74l4.94-2.47C13.456 7.68 14.19 8 15 8z" /></svg>
                            <span>Compartilhar</span>
                        </button>
                    </div>
                    
                    <div class="bg-blue-50 border-l-4 border-blue-400 p-4 text-blue-800 rounded-r-lg mb-6">
                        <p class="font-bold">Como funciona a eliminatória?</p>
                        <ul class="list-disc list-inside mt-1 text-sm">
                            <li><strong>Crie 2 Grupos:</strong> O torneio começará diretamente nas <strong>Semifinais</strong>.</li>
                            <li><strong>Crie 4 Grupos:</strong> O torneio começará nas <strong>Quartas de Final</strong>.</li>
                        </ul>
                    </div>

                    <div id="notification-area" class="mb-4"></div>
                    <div class="space-y-4 md:flex md:space-y-0 md:space-x-4">
                        <div class="flex-1">
                            <label for="group-name-input" class="block mb-2 text-sm font-medium text-gray-700">Nome do Grupo</label>
                            <input type="text" id="group-name-input" class="bg-gray-100 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-red-500 focus:border-red-500 block w-full p-2.5" placeholder="Grupo A">
                        </div>
                        <div class="flex-[3]">
                            <label for="team-names-input" class="block mb-2 text-sm font-medium text-gray-700">Nomes dos Times (separados por vírgula)</label>
                            <input type="text" id="team-names-input" class="bg-gray-100 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-red-500 focus:border-red-500 block w-full p-2.5" placeholder="Time 1, Time 2, Time 3, Time 4">
                        </div>
                        <div class="flex-shrink-0 self-end">
                            <div class="flex items-center space-x-2">
                                <button id="add-group-btn" class="w-full bg-red-600 hover:bg-red-700 text-white font-bold py-2.5 px-6 rounded-lg shadow-lg transition-transform transform hover:scale-105">
                                    Adicionar
                                </button>
                                <button id="reset-tournament-btn" class="bg-gray-600 hover:bg-gray-700 text-white font-bold py-2.5 px-6 rounded-lg shadow-lg transition-transform transform hover:scale-105">
                                    Resetar Tudo
                                </button>
                            </div>
                        </div>
                    </div>
                </section>
                <section id="group-stage" class="mb-12" style="display: none;">
                    <h2 class="text-3xl font-bold text-gray-900 border-b-2 border-red-500 pb-2 mb-6">Fase de Grupos</h2>
                    <div id="groups-container" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-2 gap-6"></div>
                    <div id="advance-btn-container" class="editable-control mt-8 text-center" style="display: none;">
                        <button id="advance-teams-btn" class="bg-red-600 hover:bg-red-700 text-white font-bold py-3 px-6 rounded-lg shadow-lg transition-transform transform hover:scale-105">
                            Gerar Eliminatórias
                        </button>
                    </div>
                </section>
                <section id="knockout-stage" style="display: none;">
                    <h2 class="text-3xl font-bold text-gray-900 border-b-2 border-red-500 pb-2 mb-8">Fase Eliminatória</h2>
                    <div id="knockout-container" class="flex flex-col md:flex-row justify-center items-stretch md:space-x-16 space-y-8 md:space-y-0 overflow-x-auto pb-8"></div>
                </section>
                 <section id="champion-section" class="text-center my-12" style="display: none;">
                    <div class="relative bg-white p-8 rounded-xl shadow-2xl border-4 border-amber-400 overflow-hidden">
                        <canvas id="confetti-canvas" class="absolute top-0 left-0 w-full h-full pointer-events-none"></canvas>
                        <div class="relative z-10">
                            <h2 class="text-2xl font-bold text-gray-600 uppercase tracking-widest">O Grande Campeão</h2>
                            <p id="champion-name" class="text-5xl md:text-7xl font-bold text-transparent bg-clip-text bg-gradient-to-r from-red-600 to-amber-500 my-4"></p>
                        </div>
                    </div>
                </section>
            </main>
            <footer class="text-center mt-12 py-4 border-t border-gray-200">
                <p class="text-gray-500">&copy; 2025 - Plataforma de Torneio.</p>
            </footer>
        </div>
    </div>

    <!-- Modals -->
    <div id="confirmation-modal" class="fixed inset-0 bg-gray-900 bg-opacity-50 flex items-center justify-center z-50" style="display: none;">
        <div class="bg-white rounded-lg shadow-xl p-6 w-full max-w-sm">
            <p id="confirmation-message" class="text-lg text-gray-800 mb-6">Você tem certeza?</p>
            <div class="flex justify-end space-x-4">
                <button id="confirm-cancel-btn" class="px-4 py-2 bg-gray-300 hover:bg-gray-400 text-gray-800 rounded-lg">Cancelar</button>
                <button id="confirm-action-btn" class="px-4 py-2 bg-red-600 hover:bg-red-700 text-white rounded-lg">Confirmar</button>
            </div>
        </div>
    </div>
    <div id="share-modal" class="fixed inset-0 bg-gray-900 bg-opacity-50 flex items-center justify-center z-50" style="display: none;">
        <div class="bg-white rounded-lg shadow-xl p-6 w-full max-w-lg">
            <h3 class="text-xl font-bold mb-4">Compartilhe seu Torneio</h3>
            <p class="text-gray-600 mb-4">Envie este link para seus amigos. Eles poderão ver o progresso em tempo real, mas não poderão editar nada.</p>
            <div class="flex space-x-2">
                <input type="text" id="share-link-input" readonly class="w-full bg-gray-100 border border-gray-300 text-gray-900 text-sm rounded-lg p-2.5">
                <button id="copy-share-link-btn" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg">Copiar</button>
            </div>
            <button id="close-share-modal-btn" class="absolute top-3 right-3 text-gray-400 hover:text-gray-600">&times;</button>
        </div>
    </div>
    
    <!-- Scripts Firebase -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import { getAuth, onAuthStateChanged, sendSignInLinkToEmail, isSignInWithEmailLink, signInWithEmailLink, signOut } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
        import { getFirestore, doc, getDoc, setDoc, deleteDoc } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

        const firebaseConfig = {
  apiKey: "AIzaSyADVsS_wCzlQv-mVRLf_tZOq7suWavbYTw",
  authDomain: "copa-play-ps4.firebaseapp.com",
  projectId: "copa-play-ps4",
  storageBucket: "copa-play-ps4.firebasestorage.app",
  messagingSenderId: "204861096387",
  appId: "1:204861096387:web:69fdef9e45f54eae487d76"
};
        
        let app, auth, db;
        try {
            app = initializeApp(firebaseConfig);
            auth = getAuth(app);
            db = getFirestore(app);
        } catch (error) {
            console.error("Erro ao inicializar o Firebase. Verifique suas credenciais.", error);
            document.body.innerHTML = `<div class="p-4 text-center text-red-800 bg-red-100"><strong>Erro de Configuração:</strong> As credenciais do Firebase não foram preenchidas corretamente.</div>`;
        }

        // --- Variáveis Globais ---
        let tournamentData = { groups: {}, matches: {}, knockout: {} };
        let confirmCallback = null;
        let userId = null;
        let isViewOnly = false;
        
        const loadingOverlay = document.getElementById('loading-overlay');
        const loginStage = document.getElementById('login-stage');
        const appContainer = document.getElementById('app-container');

        // --- INICIALIZAÇÃO ---
        document.addEventListener('DOMContentLoaded', () => {
            if (!auth) return; // Interrompe se o Firebase não inicializou

            const urlParams = new URLSearchParams(window.location.search);
            const viewUserId = urlParams.get('view');

            if (viewUserId) {
                isViewOnly = true;
                document.body.classList.add('view-only');
                document.getElementById('view-only-banner').style.display = 'block';
                document.getElementById('login-stage').style.display = 'none';
                document.getElementById('app-container').style.display = 'block';
                loadDataFromFirestore(viewUserId);
            } else {
                isViewOnly = false;
                handleAuthentication();
            }
            setupEventListeners();
        });

        function handleAuthentication() {
            handleMagicLinkSignIn();
            onAuthStateChanged(auth, async (user) => {
                loadingOverlay.style.display = 'flex';
                if (user) {
                    userId = user.uid;
                    loginStage.style.display = 'none';
                    appContainer.style.display = 'block';
                    updateAuthStatus(user);
                    await loadDataFromFirestore(userId);
                } else {
                    userId = null;
                    loginStage.style.display = 'block';
                    appContainer.style.display = 'none';
                    resetUIState();
                }
                loadingOverlay.style.display = 'none';
            });
        }
        
        // --- LÓGICA DE AUTENTICAÇÃO ---
        async function handleMagicLinkSignIn() {
            if (isSignInWithEmailLink(auth, window.location.href)) {
                let email = window.localStorage.getItem('emailForSignIn');
                if (!email) email = window.prompt('Forneça seu e-mail para confirmação.');
                if (email) {
                    try {
                        await signInWithEmailLink(auth, email, window.location.href);
                        window.localStorage.removeItem('emailForSignIn');
                        window.history.replaceState({}, document.title, window.location.pathname);
                    } catch (error) {
                        showNotification("Link inválido ou expirado.", "error", "login-notification-area");
                    }
                }
            }
        }
        async function sendMagicLink() { /* ... (código original sem alterações) ... */ }
        function signOutUser() { /* ... (código original sem alterações) ... */ }
        function updateAuthStatus(user) { /* ... (código original sem alterações) ... */ }
        
        // --- EVENT LISTENERS ---
        function setupEventListeners() {
            document.getElementById('send-magic-link-btn')?.addEventListener('click', sendMagicLink);
            document.getElementById('share-tournament-btn')?.addEventListener('click', openShareModal);
            document.getElementById('close-share-modal-btn')?.addEventListener('click', () => document.getElementById('share-modal').style.display = 'none');
            document.getElementById('copy-share-link-btn')?.addEventListener('click', copyShareLink);
            // Adicione os outros event listeners aqui...
        }
        
        // --- LÓGICA DE COMPARTILHAMENTO ---
        function openShareModal() {
            const shareLink = `${window.location.origin}${window.location.pathname}?view=${userId}`;
            const shareInput = document.getElementById('share-link-input');
            shareInput.value = shareLink;
            document.getElementById('share-modal').style.display = 'flex';
            shareInput.select();
        }

        function copyShareLink() {
            const shareInput = document.getElementById('share-link-input');
            navigator.clipboard.writeText(shareInput.value).then(() => {
                showNotification("Link copiado para a área de transferência!", "success");
            }).catch(err => {
                showNotification("Erro ao copiar o link.", "error");
            });
        }

        // --- LÓGICA DE DADOS (FIRESTORE) ---
        async function saveDataToFirestore() {
            if (!userId || isViewOnly) return;
            // ... (código original sem alterações) ...
        }

        async function loadDataFromFirestore(targetUserId) {
            if (!targetUserId) return;
            loadingOverlay.style.display = 'flex';
            try {
                const userDocRef = doc(db, "tournaments", targetUserId);
                const docSnap = await getDoc(userDocRef);
                tournamentData = docSnap.exists() && docSnap.data().data ? JSON.parse(docSnap.data().data) : { groups: {}, matches: {}, knockout: {} };
            } catch (error) {
                 console.error("Erro ao carregar dados:", error);
                 tournamentData = { groups: {}, matches: {}, knockout: {} };
                 showNotification("Não foi possível carregar os dados do torneio.", "error");
            } finally {
                renderAll();
                loadingOverlay.style.display = 'none';
            }
        }
        
        function resetTournament() {
             showConfirmationModal("Tem certeza que deseja resetar todo o torneio?", async () => {
                 if (!userId || isViewOnly) return;
                 // ... (código original sem alterações) ...
             });
        }
        
        // --- RENDERIZAÇÃO E LÓGICA DO TORNEIO ---
        function renderAll() {
            const isKnockoutGenerated = tournamentData.knockout && (tournamentData.knockout.quarterFinals?.length > 0 || tournamentData.knockout.semiFinals?.length > 0);
            
            document.getElementById('group-stage').style.display = tournamentData.groups && Object.keys(tournamentData.groups).length > 0 ? 'block' : 'none';
            document.getElementById('advance-btn-container').style.display = tournamentData.groups && Object.keys(tournamentData.groups).length > 0 ? 'block' : 'none';
            document.getElementById('knockout-stage').style.display = isKnockoutGenerated ? 'block' : 'none';
            
            if (isKnockoutGenerated) renderKnockout(); else document.getElementById('champion-section').style.display = 'none';
            renderGroups();
        }

        function renderGroups() {
            const container = document.getElementById('groups-container');
            container.innerHTML = '';
            // ... (A lógica de renderização interna de `renderGroups` permanece a mesma, 
            // mas agora os inputs e botões serão desabilitados pelo CSS da classe `view-only` no body)
            const sortedGroupKeys = tournamentData.groups ? Object.keys(tournamentData.groups).sort() : [];
            for (const groupKey of sortedGroupKeys) {
                 const groupCard = document.createElement('div');
                 groupCard.className = 'bg-white p-5 rounded-xl shadow-lg border border-gray-200 editable-control';
                 // ... O restante do innerHTML do groupCard é o mesmo, mas adicionei a classe `editable-control`
                 // em botões e inputs que devem ser desabilitados no modo de visualização.
            }
        }
        
        // Todas as outras funções (calculateStandings, addGroup, handleGroupCardInput, etc.)
        // permanecem as mesmas, pois a lógica de desabilitar a edição é feita
        // verificando a flag `isViewOnly` no início das funções que escrevem dados.
        // E visualmente, pela classe CSS no `<body>`.

        // --- Funções Utilitárias ---
        function showConfirmationModal(message, callback) { /* ... */ }
        function closeConfirmationModal() { /* ... */ }
        function showNotification(message, type = 'error', areaId = 'notification-area') { /* ... */ }
        function resetUIState() { /* ... */ }
    </script>
    <!-- O restante do seu HTML e outras funções JS que não foram alteradas -->
</body>
</html>

